<!--  guide_dashboard.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Guide Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Light Theme Colors */
            --bg-primary: linear-gradient(135deg, #f6f8fc 0%, #e2e8f0 100%);
            --bg-secondary: rgba(255, 255, 255, 0.9);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.8);
            --text-primary: #1a202c;
            --text-secondary: #2d3748;
            --text-muted: #4a5568;
            --accent-color: #4c51bf;
            --accent-hover: #434190;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(0, 0, 0, 0.2);
            --success: #48bb78;
            --error: #f56565;
            --warning: #ed8936;

            /* Animations */
            --transition-speed: 0.3s;
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --smooth: cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        :root[data-theme="dark"] {
            /* Dark Theme Colors */
            --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-secondary: rgba(26, 32, 44, 0.7);
            --glass-bg: rgba(45, 55, 72, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #a0aec0;
            --accent-color: #9f7aea;
            --accent-hover: #b794f4;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.5);
            --success: #48bb78;
            --error: #f56565;
            --warning: #ed8936;
        }

        /* ========================================
           BASE STYLES
           ======================================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: all 0.3s var(--smooth);
            position: relative;
            min-height: 100vh;
        }

        /* Animated Background Particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(159, 122, 234, 0.1) 0%, transparent 50%);
            animation: backgroundPulse 15s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundPulse {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 0.8;
            }
        }

        /* ========================================
           CONTAINER & LAYOUT
           ======================================== */

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* ========================================
           GLASS MORPHISM EFFECTS - NO SCALING
           ======================================== */

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s var(--smooth);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            border: 1.5px solid var(--glass-border);
            border-radius: 24px;
            box-shadow:
                0 12px 40px var(--shadow-color),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s var(--smooth);
        }

        [data-theme="dark"] .glass-strong {
            background: rgba(45, 55, 72, 0.5);
        }

        /* ========================================
           HEADER
           ======================================== */

        header {
            padding: 20px 30px;
            margin-bottom: 30px;
            animation: slideDown 0.6s var(--bounce);
        }

        @keyframes slideDown {
            0% {
                transform: translateY(-100px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all var(--transition-speed) var(--smooth);
            letter-spacing: -0.5px;
        }

        .logo:hover {
            filter: brightness(1.2);
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-links span {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        /* ========================================
           THEME TOGGLE BUTTON
           ======================================== */

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid var(--glass-border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s var(--smooth);
            box-shadow:
                0 4px 12px var(--shadow-color),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .theme-toggle:hover {
            box-shadow:
                0 8px 24px var(--shadow-hover),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle svg {
            width: 24px;
            height: 24px;
            fill: var(--text-primary);
            transition: all 0.3s var(--smooth);
            opacity: 0.8;
        }

        .theme-toggle:hover svg {
            opacity: 1;
            fill: var(--accent-color);
        }

        /* ========================================
           DASHBOARD LAYOUT
           ======================================== */

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
            animation: fadeInUp 0.8s var(--smooth);
        }

        @keyframes fadeInUp {
            0% {
                transform: translateY(40px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ========================================
           SIDEBAR
           ======================================== */

        .sidebar {
            padding: 30px 0;
            height: fit-content;
            position: sticky;
            top: 20px;
            animation: slideInLeft 0.6s var(--bounce);
        }

        @keyframes slideInLeft {
            0% {
                transform: translateX(-100px);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 8px;
            animation: fadeIn 0.5s var(--smooth) backwards;
        }

        .sidebar-menu li:nth-child(1) {
            animation-delay: 0.1s;
        }

        .sidebar-menu li:nth-child(2) {
            animation-delay: 0.2s;
        }

        .sidebar-menu li:nth-child(3) {
            animation-delay: 0.3s;
        }

        .sidebar-menu li:nth-child(4) {
            animation-delay: 0.4s;
        }

        .sidebar-menu li:nth-child(5) {
            animation-delay: 0.5s;
        }

        .sidebar-menu li:nth-child(6) {
            animation-delay: 0.6s;
        }

        .sidebar-menu li:nth-child(7) {
            animation-delay: 0.7s;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateX(-20px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 25px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s var(--smooth);
            font-weight: 500;
            position: relative;
        }

        .sidebar-menu a:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.08);
            color: var(--accent-color);
            font-weight: 600;
            border-left: 3px solid var(--accent-color);
        }

        .sidebar-menu a.coming-soon {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .sidebar-menu a.coming-soon::after {
            content: 'Soon';
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 600;
        }

        /* ========================================
           MAIN CONTENT
           ======================================== */

        .dashboard-content {
            padding: 40px;
            min-height: 80vh;
            animation: slideInRight 0.6s var(--bounce);
        }

        @keyframes slideInRight {
            0% {
                transform: translateX(100px);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .welcome-message {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: slideInDown 0.6s var(--bounce);
            letter-spacing: -1px;
        }

        @keyframes slideInDown {
            0% {
                transform: translateY(-30px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        h1,
        h2,
        h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-weight: 600;
        }

        h2 {
            font-size: 1.8rem;
            margin-top: 30px;
            position: relative;
            display: inline-block;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
            border-radius: 2px;
        }

        /* ========================================
           CARDS - NO SCALING, ONLY SHADOW TRANSITIONS
           ======================================== */

        .card {
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s var(--smooth);
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 12px 40px var(--shadow-hover);
        }

        .card h3 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.3rem;
        }

        .card p {
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .card small {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* ========================================
           USER LIST & CARDS - NO SCALING
           ======================================== */

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            padding: 25px;
            text-align: center;
            position: relative;
            animation: popIn 0.5s var(--bounce) backwards;
            transition: all 0.3s var(--smooth);
        }

        .user-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .user-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .user-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .user-card:nth-child(4) {
            animation-delay: 0.4s;
        }

        @keyframes popIn {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .user-card:hover {
            box-shadow: 0 12px 40px var(--shadow-hover);
        }

        .user-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid var(--glass-border);
            transition: all var(--transition-speed) var(--smooth);
        }

        .user-card:hover img {
            border-color: var(--accent-color);
            box-shadow: 0 8px 24px var(--shadow-color);
        }

        .user-status {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--glass-bg);
        }

        .status-online {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .status-offline {
            background: var(--text-muted);
        }

        /* ========================================
           BUTTONS - NO SCALING, ONLY SHADOW EFFECTS
           ======================================== */

        .btn {
            display: inline-block;
            padding: 12px 28px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            font-weight: 600;
            transition: all var(--transition-speed) var(--smooth);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            font-size: 0.95rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            box-shadow: 0 8px 24px var(--shadow-hover);
            border-color: var(--accent-color);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        }

        /* ========================================
           FORMS
           ======================================== */

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-speed) var(--smooth);
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        /* ========================================
           TABLE - NO SCALING
           ======================================== */

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            margin-top: 20px;
        }

        .table thead tr {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .table th {
            padding: 15px 20px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table th:first-child {
            border-radius: 12px 0 0 12px;
        }

        .table th:last-child {
            border-radius: 0 12px 12px 0;
        }

        .table tbody tr {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            transition: all var(--transition-speed) var(--smooth);
            animation: slideInLeft 0.5s var(--smooth) backwards;
        }

        .table tbody tr:nth-child(1) {
            animation-delay: 0.1s;
        }

        .table tbody tr:nth-child(2) {
            animation-delay: 0.2s;
        }

        .table tbody tr:nth-child(3) {
            animation-delay: 0.3s;
        }

        .table tbody tr:nth-child(4) {
            animation-delay: 0.4s;
        }

        .table tbody tr:nth-child(5) {
            animation-delay: 0.5s;
        }

        .table tbody tr:hover {
            box-shadow: 0 8px 24px var(--shadow-hover);
        }

        .table td {
            padding: 18px 20px;
            color: var(--text-primary);
        }

        .table td:first-child {
            border-radius: 12px 0 0 12px;
        }

        .table td:last-child {
            border-radius: 0 12px 12px 0;
        }

        /* ========================================
           ALERTS
           ======================================== */

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border-left: 4px solid;
            animation: slideInRight 0.5s var(--bounce);
            font-weight: 500;
        }

        .alert-success {
            background: rgba(72, 187, 120, 0.15);
            border-color: var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(245, 101, 101, 0.15);
            border-color: var(--error);
            color: var(--error);
        }

        .alert-warning {
            background: rgba(237, 137, 54, 0.15);
            border-color: var(--warning);
            color: var(--warning);
        }

        /* ========================================
           TAB CONTENT TRANSITIONS
           ======================================== */

        .tab-content {
            display: none;
            animation: fadeInScale 0.5s var(--smooth);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        /* ========================================
           BADGE
           ======================================== */

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-color);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ========================================
           SCROLLBAR STYLING
           ======================================== */

        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
            transition: all var(--transition-speed) var(--smooth);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
            background-clip: padding-box;
        }

        /* ========================================
           RESPONSIVE DESIGN
           ======================================== */

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                top: 0;
            }

            .theme-toggle {
                top: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .dashboard-content {
                padding: 20px;
            }

            .user-list {
                grid-template-columns: 1fr;
            }

            .welcome-message {
                font-size: 1.8rem;
            }

            .table {
                font-size: 0.85rem;
            }

            .table th,
            .table td {
                padding: 12px 15px;
            }
        }

        /* ========================================
           UTILITY CLASSES
           ======================================== */

        .mt-10 {
            margin-top: 10px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .text-center {
            text-align: center;
        }

        .text-primary {
            color: var(--text-primary);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .text-muted {
            color: var(--text-muted);
        }

        .hidden {
            display: none;
        }

        /* assigment css  */
        assignment-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .question-block {
            background: var(--hover-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent-color);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .remove-question-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        .submission-card {
            background: var(--glass-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--glass-border);
        }

        .flag-badge {
            background: var(--error);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .answer-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .answer-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .answer-image {
            width: 100%;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .answer-image:hover {
            transform: scale(1.05);
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .score-item {
            background: var(--hover-bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .score-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .feedback-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid var(--accent-color);
            border-radius: 8px;
        }

        .points-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .points-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .points-list li::before {
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .covered-point::before {
            content: '✅';
        }

        .missing-point::before {
            content: '❌';
        }

        .scores-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            margin-top: 20px;
        }

        .scores-table th {
            background: var(--hover-bg);
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .scores-table td {
            background: var(--glass-bg);
            padding: 15px;
            border: 1px solid var(--glass-border);
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .visibility-toggle {
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .answer-images {
                grid-template-columns: 1fr;
            }

            .score-breakdown {
                grid-template-columns: 1fr;
            }
        }

        /* MCQ Results Styling */
        .mcq-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .mcq-stat-card {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .mcq-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px var(--shadow-hover);
        }

        .mcq-stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .mcq-stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .mcq-stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }

        /* Force file input to be visible and clickable */
        input[type="file"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: relative !important;
            z-index: 1 !important;
        }

        input[type="file"]:hover {
            border-color: var(--accent-color);
            background: var(--glass-bg);
        }

        input[type="file"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Style the file input for better UX */
        input[type="file"]::file-selector-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 15px;
            transition: all 0.3s ease;
        }

        input[type="file"]::file-selector-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Modal Styles for Summary Dialog */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: 0 20px 60px var(--shadow-color);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: var(--accent-color);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
            margin: 0 4px;
        }

        /* ==================== GUIDE SUMMARIZER RESPONSIVE STYLES ==================== */
        #guide-summarizer {
            padding: 20px;
        }

        #guide-summarizer .card {
            margin-bottom: 25px;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        #guide-summarizer .form-group {
            margin-bottom: 20px;
        }

        #guide-summarizer label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        #guide-summarizer select,
        #guide-summarizer input[type="file"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            background: var(--glass-bg);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        #guide-summarizer select:focus,
        #guide-summarizer input[type="file"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #guide-summarizer small {
            display: block;
            margin-top: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        #guide-summarizer .btn-primary {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            margin-top: 10px;
        }

        #summarizer-documents-list {
            margin-top: 15px;
        }

        #summarizer-documents-list table {
            width: 100%;
            border-collapse: collapse;
        }

        #summarizer-documents-list th {
            padding: 12px;
            text-align: left;
            background: var(--glass-bg);
            color: var(--text-primary);
            font-weight: 600;
            border-bottom: 2px solid var(--glass-border);
        }

        #summarizer-documents-list td {
            padding: 12px;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        #summarizer-documents-list tr:hover {
            background: var(--hover-bg);
        }

        /* Voice Input Button */
        .voice-input-btn {
            background: var(--accent-secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .voice-input-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .voice-input-btn.recording {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ========================================
           UNIVERSAL SCOREBOARD
           ======================================== */
        .scoreboard-card {
            border-radius: 24px;
            padding: 1.75rem;
            background: rgba(15, 23, 42, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
            backdrop-filter: blur(18px);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .scoreboard-card h1 {
            margin-bottom: 0;
        }

        .scoreboard-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            align-items: flex-end;
        }

        .scoreboard-controls .form-group {
            margin-bottom: 0;
        }

        .scoreboard-controls select {
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.08);
            padding: 12px 16px;
            color: var(--text-primary);
        }

        .scoreboard-controls button {
            justify-self: flex-end;
        }

        .scoreboard-summary {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: baseline;
        }

        .scoreboard-summary strong {
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .scoreboard-summary-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: flex-start;
        }

        .scoreboard-summary-tags span {
            padding: 0.35rem 0.9rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 999px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .scoreboard-column-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .scoreboard-column-form div {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .scoreboard-column-form input {
            flex: 1;
            min-width: 180px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            padding: 10px 14px;
            font-size: 1rem;
        }

        .scoreboard-column-form button {
            border-radius: 12px;
            border: none;
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: #fff;
            font-weight: 600;
            min-width: 150px;
            box-shadow: 0 10px 30px rgba(76, 81, 191, 0.25);
        }

        .scoreboard-note {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .scoreboard-note i {
            color: var(--accent-color);
        }

        .scoreboard-table-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .scoreboard-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 760px;
            font-size: 0.95rem;
        }

        .scoreboard-table thead th {
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.95);
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            padding: 16px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        .scoreboard-table tbody tr {
            background: rgba(255, 255, 255, 0.03);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .scoreboard-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.015);
        }

        .scoreboard-table tbody tr:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
        }

        .scoreboard-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
            color: var(--text-primary);
        }

        .scoreboard-table tfoot td {
            font-weight: 600;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .score-input-group {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .score-input-group input {
            width: 90px;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            text-align: center;
            background: rgba(255, 255, 255, 0.12);
        }

        .score-input-group button {
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            background: rgba(59, 130, 246, 0.9);
            color: #fff;
            font-size: 0.85rem;
        }

        .score-input-button {
            padding: 0.45rem 1rem;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(96, 165, 250, 0.95));
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.2px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.35);
        }

        .score-input-button:active {
            transform: translateY(1px) scale(0.98);
        }

        .score-input-status {
            display: block;
            margin-top: 4px;
            font-size: 0.8rem;
            min-height: 1.2rem;
        }

        .scoreboard-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        @media (max-width: 1024px) {
            .scoreboard-table thead {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0 0 0 0);
                border: 0;
            }

            .scoreboard-table tbody tr {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.35rem;
                padding: 1rem 1.25rem;
                border-radius: 18px;
                margin-bottom: 0.75rem;
                background: rgba(15, 23, 42, 0.85);
                border: 1px solid rgba(255, 255, 255, 0.12);
                box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
            }

            .scoreboard-table tbody tr td {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: flex-start;
                padding: 0;
                border: none;
                gap: 0.35rem;
            }

            .scoreboard-table tbody tr td::before {
                content: attr(data-label);
                font-size: 0.72rem;
                letter-spacing: 0.12em;
                text-transform: uppercase;
                color: var(--text-secondary);
                width: 100%;
            }

            .scoreboard-table tbody tr td > * {
                width: 100%;
            }

            .scoreboard-table tfoot {
                display: none;
            }

            .score-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .score-input-group button {
                width: 100%;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #guide-summarizer {
                padding: 15px;
            }

            #guide-summarizer .card {
                padding: 20px;
                margin-bottom: 20px;
            }

            #summarizer-documents-list table {
                font-size: 14px;
            }

            #summarizer-documents-list th,
            #summarizer-documents-list td {
                padding: 8px;
            }

            #summarizer-documents-list .btn-sm {
                padding: 4px 8px;
                font-size: 12px;
            }

            .scoreboard-card {
                padding: 1.25rem;
            }

            .scoreboard-controls {
                grid-template-columns: 1fr;
            }

            .scoreboard-controls button {
                justify-self: stretch;
            }

            .scoreboard-summary {
                grid-template-columns: 1fr;
            }

            .scoreboard-summary-tags {
                justify-content: center;
            }

            .scoreboard-column-form div {
                flex-direction: column;
                align-items: stretch;
            }

            .scoreboard-column-form input,
            .scoreboard-column-form button {
                width: 100%;
            }

            .scoreboard-table-container {
                overflow-x: auto;
            }

            .scoreboard-table {
                min-width: unset;
                font-size: 0.85rem;
            }

            .score-input-group {
                flex-direction: column;
            }

            .score-input-group button {
                width: 100%;
            }
        }
    </style>
</head>

<body data-theme="dark">
    <div class="container">
        <header class="glass">
            <div class="header-content">
                <a href="{{ url_for('guide_dashboard') }}" class="logo">Learning Platform</a>
                <nav class="nav-links">
                    <div style="display: flex; align-items: center; gap: 12px; position: relative;">
                        <div class="user-avatar"
                            style="position: relative; cursor: pointer; width: 45px; height: 45px; border-radius: 50%; overflow: hidden; border: 2px solid var(--accent-color, #4c51bf);"
                            onclick="openEditPhotoModal()" title="Edit Profile Picture">
                            {% if current_user.profile_photo %}
                            <img src="{{ url_for('static', filename=current_user.profile_photo.replace('static/', '')) }}"
                                alt="Profile" id="profile-photo-img"
                                style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                            <i class="fas fa-user-circle" id="profile-photo-icon"
                                style="font-size: 45px; color: var(--accent-color, #4c51bf);"></i>
                            {% endif %}
                            <div
                                style="position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; background: var(--accent-color, #4c51bf); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                <i class="fas fa-camera" style="font-size: 10px; color: white;"></i>
                            </div>
                        </div>
                        <span>Welcome, {{ current_user.full_name }}</span>
                    </div>
                    <a href="{{ url_for('logout') }}" class="btn">Logout</a>
                </nav>
            </div>
        </header>

        <div class="container">
            <div class="dashboard">
                <aside class="glass sidebar">
                    <ul class="sidebar-menu">
                        <li><a href="#announcements" class="nav-tab active">Announcements</a></li>
                        <li><a href="#courses" class="nav-tab">Course Selector</a></li>
                        <li><a href="#messages" class="nav-tab">Learners & Messages</a></li>
                        <li><a href="#upload" class="nav-tab">Uploads</a></li>
                        <li><a href="#materials" class="nav-tab">Uploaded Materials</a></li>
                        <li><a href="#guide-summarizer" class="nav-tab">Guide Summarizer</a></li>
                        <li><a href="#create-assignment" class="nav-tab">Create Assignment</a></li>
                        <li><a href="#view-assignments" class="nav-tab">View Assignments</a></li>
                        <li><a href="#scores" class="nav-tab">Scores & Reports</a></li>
                        <li><a href="#mcq-results" class="nav-tab">MCQ Results</a></li>
                        <li><a href="#universal-scoreboard" class="nav-tab">Universal Scoreboard</a></li>
                        <li><a href="#plagiarism-check" class="nav-tab">Plagiarism Check</a></li>
                        <li><a href="#plagiarism-accuracy" class="nav-tab">Plagiarism Accuracy</a></li>
                        <li><a href="#test-mcq-gen" class="nav-tab">Test MCQ Gen</a></li>
                        <li><a href="#diagram-evaluation" class="nav-tab">Diagram Evaluation</a></li>


                    </ul>
                </aside>

                <main class="glass dashboard-content">
                    <!-- ANNOUNCEMENTS TAB -->
                    <div id="announcements" class="tab-content active">
                        <h1 class="welcome-message">Welcome Guide {{ current_user.full_name }}!</h1>
                        <h2>Announcements</h2>
                        {% for announcement in announcements %}
                        <div class="card glass">
                            <h3>{{ announcement.title }}</h3>
                            <p>{{ announcement.content }}</p>
                            {% if announcement.file_path %}
                            <p><a href="{{ url_for('download_file', filename=announcement.file_path.split('/')[-1]) }}"
                                    class="btn mt-20">Download Attachment</a></p>
                            {% endif %}
                            <small>Posted: {{ announcement.created_at.strftime('%B %d, %Y') }}</small>
                        </div>
                        {% else %}
                        <div class="card glass">
                            <p>No announcements yet.</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- COURSES TAB -->
                    <div id="courses" class="tab-content">
                        <h1>My Courses</h1>
                        <p class="text-secondary mb-30">You can manage up to 5 courses</p>

                        <div class="user-list">
                            {% for course in courses %}
                            <div class="card glass-strong">
                                <h3>{{ course.course_name }}</h3>
                                <p>Organization: {{ course.organization }}</p>
                                <p>Learners: <strong>{{ course.learners|length }}/20</strong></p>
                                <p class="text-muted">Last updated: {{ course.created_at.strftime('%b %d, %Y') }}</p>
                                <button class="btn btn-primary view-learners-btn mt-20" data-course-id="{{ course.id }}"
                                    data-course-name="{{ course.course_name }}">
                                    View Learners
                                </button>
                            </div>
                            {% else %}
                            <div class="card glass">
                                <p>No courses assigned yet.</p>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Learners Section (hidden by default) -->
                        <div id="learners-section" style="display: none; margin-top: 30px;">
                            <button class="btn" id="back-to-courses" style="margin-bottom: 20px;">← Back to
                                Courses</button>
                            <h1 id="course-title"></h1>
                            <div class="user-list" id="learners-container"></div>
                        </div>
                    </div>

                    <!-- MESSAGES TAB -->
                    <div id="messages" class="tab-content">
                        <h1>Learners & Messages</h1>
                        <p style="margin-bottom: 20px;">
                            <a href="{{ url_for('messages') }}" class="btn btn-primary">Open Full Messaging
                                Interface</a>
                        </p>
                        <div class="card glass">
                            <p>Use the messaging interface to communicate with learners from your courses.</p>
                        </div>
                    </div>

                    <!-- UPLOAD TAB -->
                    <div id="upload" class="tab-content">
                        <h1>Upload Materials</h1>
                        <div id="alert-container"></div>

                        <div class="card glass-strong">
                            <h3>Upload New File</h3>
                            <p class="text-secondary mb-20">Maximum file size: 50MB<br>
                                Supported formats: PDF, DOC, XLS, CSV, JPG, PNG, MP4, WEBM</p>

                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label for="course_id">Select Course</label>
                                    <select id="course_id" name="course_id" required>
                                        <option value="">Choose a course...</option>
                                        {% for course in courses %}
                                        <option value="{{ course.id }}">{{ course.course_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="file">Choose File</label>
                                    <input type="file" id="file" name="file" required style="display: block !important; 
                                               opacity: 1 !important; 
                                               position: relative !important;
                                               width: 100%;
                                               padding: 12px;
                                               border: 2px dashed var(--glass-border);
                                               border-radius: 12px;
                                               background: var(--hover-bg);
                                               cursor: pointer;
                                               transition: all 0.3s ease;"
                                        accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.jpg,.jpeg,.png,.mp4,.webm"
                                        onchange="displayFileName(this)">
                                    <small id="file-name-display"
                                        style="display: block; margin-top: 10px; color: var(--text-secondary);"></small>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-upload"></i> Upload File
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- MATERIALS TAB -->
                    <div id="materials" class="tab-content">
                        <h1>Uploaded Materials</h1>
                        <p class="text-secondary mb-30">All your uploaded course materials</p>

                        <table class="table glass">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Course</th>
                                    <th>Uploaded</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for upload in uploads %}
                                <tr>
                                    <td>{{ upload.file_name }}</td>
                                    <td><span class="badge">{{ upload.file_type|upper }}</span></td>
                                    <td>{{ "%.1f"|format(upload.file_size) }} MB</td>
                                    <td>{{ upload.course.course_name }}</td>
                                    <td>{{ upload.created_at.strftime('%b %d, %Y') }}</td>
                                    <td><a href="{{ url_for('download_file', filename=upload.file_path.split('/')[-1]) }}"
                                            class="btn">Download</a></td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No materials uploaded yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- GUIDE SUMMARIZER TAB -->
                    <div id="guide-summarizer" class="tab-content">
                        <h1>📚 Guide Summarizer</h1>
                        <p class="text-secondary mb-30">Upload documents to get AI-powered summaries and enable Q&A for
                            learners</p>

                        <div id="summarizer-alert-container"></div>

                        <!-- Upload Section -->
                        <div class="card glass-strong" style="margin-bottom: 30px;">
                            <h3>Upload Document</h3>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="summarizer-course-select">Select Course (Required)</label>
                                <select id="summarizer-course-select" class="form-select"
                                    style="width: 100%; padding: 12px; border: 2px solid var(--glass-border); border-radius: 8px; background: var(--glass-bg); color: var(--text-primary);">
                                    <option value="">Choose a course...</option>
                                    {% for course in courses %}
                                    <option value="{{ course.id }}">{{ course.course_name }}</option>
                                    {% endfor %}
                                </select>
                                <small style="color: var(--text-secondary); display: block; margin-top: 5px;">Select the
                                    course this document belongs to. Learners enrolled in this course will be able to
                                    chat with it.</small>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="summarizer-file-input">Select File (PDF, DOCX, TXT, CSV, JPG, PNG)</label>
                                <input type="file" id="summarizer-file-input"
                                    accept=".pdf,.docx,.txt,.csv,.jpg,.jpeg,.png"
                                    style="padding: 10px; border: 2px dashed var(--accent-color); border-radius: 8px; width: 100%;">
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <button type="button" class="btn btn-primary" id="summarizer-upload-btn"
                                    onclick="uploadSummarizerDocument()">
                                    <i class="fas fa-upload"></i> Upload & Summarize
                                </button>
                                <button type="button" class="voice-input-btn" id="summarizer-voice-btn"
                                    onclick="toggleVoiceInput()" title="Voice Input (Multi-language)">
                                    <i class="fas fa-microphone"></i> Voice Input
                                </button>
                            </div>
                            <div
                                style="margin-top: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <label for="voice-language-select"
                                    style="font-size: 13px; color: var(--text-secondary);">Language (optional,
                                    auto-detect if not set):</label>
                                <select id="voice-language-select"
                                    style="padding: 8px 12px; border: 1px solid var(--glass-border); border-radius: 6px; background: var(--glass-bg); color: var(--text-primary); font-size: 13px;">
                                    <option value="">Auto-detect</option>
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="ru">Russian</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ko">Korean</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ar">Arabic</option>
                                    <option value="hi">Hindi</option>
                                </select>
                            </div>
                            <div id="voice-input-status"
                                style="margin-top: 10px; display: none; padding: 10px; background: var(--glass-bg); border-radius: 8px; color: var(--text-primary);">
                                <i class="fas fa-circle" style="color: #ef4444; animation: pulse 1s infinite;"></i>
                                Recording... Click again to stop
                            </div>
                        </div>

                        <!-- Documents List -->
                        <div class="card glass-strong">
                            <h3>Your Documents</h3>
                            <div id="summarizer-documents-list">
                                <p class="text-center text-secondary">Loading documents...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Dialog Modal -->
                    <div id="summary-dialog" class="modal" style="display: none;">
                        <div class="modal-content glass-strong"
                            style="max-width: 600px; margin: 50px auto; padding: 30px;">
                            <span class="close" onclick="closeSummaryDialog()">&times;</span>
                            <h2 id="summary-dialog-title">Document Summary</h2>
                            <div id="summary-dialog-content">
                                <p><strong>Summary:</strong></p>
                                <p id="summary-text"></p>
                                <p style="margin-top: 20px;"><strong>Topics:</strong></p>
                                <div id="summary-topics"></div>
                            </div>
                        </div>
                    </div>

                    <div id="create-assignment" class="tab-content">
                        <h1>Create Assignment</h1>
                        <div id="assignment-alert"></div>

                        <div class="card glass-strong assignment-form">
                            <form id="assignmentForm">
                                <div class="form-group">
                                    <label for="assignment_course">Select Course *</label>
                                    <select id="assignment_course" name="course_id" required>
                                        <option value="">Choose course...</option>
                                        {% for course in courses %}
                                        <option value="{{ course.id }}">{{ course.course_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="assignment_name">Assignment Name *</label>
                                    <input type="text" id="assignment_name" name="name" required>
                                </div>

                                <div class="form-group">
                                    <label for="assignment_instructions">Instructions</label>
                                    <textarea id="assignment_instructions" name="instructions" rows="6"
                                        style="min-height: 150px;">Please complete this assignment with the following guidelines:
- Write clearly and legibly
- Show all your work and calculations
- Answer all questions completely
- Follow the format specified for each question
- Submit before the deadline

You can edit or remove this default text as needed.</textarea>
                                </div>

                                <div class="form-group">
                                    <label for="assignment_deadline">Deadline *</label>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                                        <button type="button" class="btn btn-sm" onclick="setDeadlineQuick('1h')"
                                            style="padding: 6px 12px; font-size: 0.85rem;">In 1 Hour</button>
                                        <button type="button" class="btn btn-sm" onclick="setDeadlineQuick('3h')"
                                            style="padding: 6px 12px; font-size: 0.85rem;">In 3 Hours</button>
                                        <button type="button" class="btn btn-sm" onclick="setDeadlineQuick('6h')"
                                            style="padding: 6px 12px; font-size: 0.85rem;">In 6 Hours</button>
                                        <button type="button" class="btn btn-sm" onclick="setDeadlineQuick('12h')"
                                            style="padding: 6px 12px; font-size: 0.85rem;">In 12 Hours</button>
                                        <button type="button" class="btn btn-sm" onclick="setDeadlineQuick('tomorrow')"
                                            style="padding: 6px 12px; font-size: 0.85rem;">Tomorrow</button>
                                        <button type="button" class="btn btn-sm" onclick="setDeadlineQuick('2d')"
                                            style="padding: 6px 12px; font-size: 0.85rem;">After 2 Days</button>
                                        <button type="button" class="btn btn-sm" onclick="setDeadlineQuick('3d')"
                                            style="padding: 6px 12px; font-size: 0.85rem;">After 3 Days</button>
                                        <button type="button" class="btn btn-sm" onclick="setDeadlineQuick('7d')"
                                            style="padding: 6px 12px; font-size: 0.85rem;">After 1 Week</button>
                                    </div>
                                    <input type="datetime-local" id="assignment_deadline" name="deadline" required>
                                </div>

                                <div class="form-group">
                                    <label for="evaluation_model">Evaluation Model *</label>
                                    <select id="evaluation_model" name="evaluation_model" required>
                                        <option value="gemini" selected>Gemini Flash 2.5 (Default - Free)</option>
                                        <option value="deepseek">DeepSeek Chat (Free Model)</option>
                                        <option value="groq">Groq Llama 3.3 70B (Free Model)</option>
                                    </select>
                                </div>

                                <h3 style="margin-top: 30px;">Questions (No Answer Keys)</h3>
                                <div id="questions-container"></div>

                                <button type="button" class="btn" onclick="addQuestion()">
                                    <i class="fas fa-plus"></i> Add Question
                                </button>

                                <div class="form-group" style="margin-top: 30px;">
                                    <label>Total Marks: <span id="total-marks">0</span></label>
                                </div>

                                <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
                                    <i class="fas fa-save"></i> Create Assignment
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- VIEW ASSIGNMENTS TAB -->
                    <div id="view-assignments" class="tab-content">
                        <h1>View Assignments & Submissions</h1>

                        <div id="assignments-list"></div>
                    </div>

                    <!-- SCORES TAB -->
                    <div id="scores" class="tab-content">
                        <h1>Scores & Reports</h1>

                        <div class="card glass-strong">
                            <div class="form-group">
                                <label for="scores_assignment">Select Assignment</label>
                                <select id="scores_assignment">
                                    <option value="">Choose assignment...</option>
                                </select>
                            </div>

                            <div id="scores-container"></div>
                        </div>
                    </div>

                    <!-- MCQ RESULTS TAB -->
                    <div id="mcq-results" class="tab-content">
                        <h1>MCQ Verification Results</h1>

                        <div class="card glass-strong">
                            <div class="form-group">
                                <label for="mcq_assignment">Select Assignment</label>
                                <select id="mcq_assignment">
                                    <option value="">Choose assignment...</option>
                                </select>
                            </div>

                            <div id="mcq-results-container"></div>
                        </div>
                    </div>
                    <!-- UNIVERSAL SCOREBOARD TAB -->
                    <div id="universal-scoreboard" class="tab-content">
                        <h1>Universal Scoreboard</h1>
                        <p class="text-secondary mb-20">
                            View aggregated coursework across handwritten assignments, MCQ tests and your own custom
                            metrics.
                        </p>

                        <div class="card glass-strong scoreboard-card">
                            <div class="scoreboard-controls">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="scoreboard_course_select">Select Course</label>
                                    <select id="scoreboard_course_select">
                                        <option value="">Choose course...</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" id="scoreboard-download-btn" disabled>
                                    <i class="fas fa-download"></i> Download PDF Report
                                </button>
                            </div>

                            <div class="scoreboard-summary">
                                <strong id="scoreboard-course-title">Select a course to load the universal
                                    scoreboard</strong>
                                <div class="scoreboard-summary-tags">
                                    <span id="scoreboard-assignment-summary"></span>
                                    <span id="scoreboard-mcq-summary"></span>
                                </div>
                            </div>
                            <div class="scoreboard-note">
                                <i class="fas fa-pencil-alt"></i>
                                <span>Update learner metrics inline and tap Save on each custom column to persist changes.</span>
                            </div>

                            <form id="scoreboard-column-form" class="scoreboard-column-form">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="scoreboard-column-name">Add a custom column</label>
                                <div>
                                        <input type="text" id="scoreboard-column-name"
                                            placeholder="Column name (e.g., Oral Test)" required>
                                        <input type="number" step="0.5" min="0" id="scoreboard-column-total"
                                            placeholder="Total marks" required>
                                        <button class="btn btn-outline" type="submit">Create Column</button>
                                    </div>
                                    <small id="scoreboard-column-feedback" class="text-secondary"></small>
                                </div>
                            </form>

                            <div class="scoreboard-table-container">
                                <table class="scoreboard-table">
                                    <thead>
                                        <tr id="scoreboard-table-head"></tr>
                                    </thead>
                                    <tbody id="scoreboard-table-body"></tbody>
                                    <tfoot id="scoreboard-table-foot"></tfoot>
                                </table>
                                <div id="scoreboard-empty" class="scoreboard-empty" style="display:none;">
                                    <p>No learners enrolled for this course yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- PLAGIARISM CHECK TAB -->
                    <div id="plagiarism-check" class="tab-content">
                        <h1>Plagiarism Detection</h1>
                        <p class="text-secondary mb-30">Review and manage plagiarism matches</p>

                        <div class="card glass-strong">
                            <div class="form-group">
                                <label for="plagiarism_assignment">Select Assignment</label>
                                <select id="plagiarism_assignment">
                                    <option value="">Choose assignment...</option>
                                </select>
                            </div>
                            <div id="plagiarism-results-container"></div>
                        </div>
                    </div>

                    <!-- PLAGIARISM ACCURACY TAB -->
                    <div id="plagiarism-accuracy" class="tab-content">
                        <h1>Plagiarism Accuracy Analysis</h1>
                        <p class="text-secondary mb-30">View detailed plagiarism and AI detection results for each
                            submission</p>

                        <div class="card glass-strong">
                            <div class="form-group">
                                <label for="plagiarism_accuracy_assignment">Select Assignment</label>
                                <select id="plagiarism_accuracy_assignment">
                                    <option value="">Choose assignment...</option>
                                </select>
                            </div>
                            <div id="plagiarism-accuracy-container"></div>
                        </div>
                    </div>

                    <!-- TEST MCQ GENERATION TAB -->
                    <div id="test-mcq-gen" class="tab-content">
                        <h1>Test MCQ Generator</h1>
                        <p class="text-secondary mb-30">Generate MCQs from topics or documents using Gemini AI</p>

                        <div class="card glass-strong">
                            <div
                                style="display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid var(--glass-border);">
                                <button class="tab-btn active" onclick="switchMCQTab('create')"
                                    style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid var(--accent-color); color: var(--accent-color); font-size: 1rem; font-weight: 500; cursor: pointer;">Create
                                    MCQ</button>
                                <button class="tab-btn" onclick="switchMCQTab('list')"
                                    style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-size: 1rem; font-weight: 500; cursor: pointer;">My
                                    MCQs</button>
                            </div>

                            <!-- Create MCQ Tab -->
                            <div id="mcq-create-tab" class="mcq-subtab" style="display: block;">
                                <div class="form-group">
                                    <label for="mcq_course_select">Select Course *</label>
                                    <select id="mcq_course_select" required>
                                        <option value="">Choose a course...</option>
                                    </select>
                                    <small style="color: var(--text-secondary); font-size: 0.85rem;">Select the course
                                        for this MCQ test</small>
                                </div>

                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 12px; font-weight: 600;">Input
                                        Type</label>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                        <label
                                            style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.3s; min-width: 150px;"
                                            onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='var(--accent-color)'"
                                            onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                                            <input type="radio" name="mcqInputType" value="topic" checked
                                                onchange="toggleMCQInput()"
                                                style="margin: 0; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;">
                                            <span style="font-size: 0.95rem; white-space: nowrap;">Topic</span>
                                        </label>
                                        <label
                                            style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.3s; min-width: 150px;"
                                            onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='var(--accent-color)'"
                                            onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                                            <input type="radio" name="mcqInputType" value="document"
                                                onchange="toggleMCQInput()"
                                                style="margin: 0; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;">
                                            <span style="font-size: 0.95rem; white-space: nowrap;">Document
                                                (PDF/CSV/TXT/DOCX)</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="mcq-topic-input">
                                    <div class="form-group">
                                        <label for="mcq_topic_text">Enter Topic</label>
                                        <textarea id="mcq_topic_text"
                                            placeholder="e.g., Quantum Physics, World War II, Machine Learning..."
                                            style="min-height: 100px;"></textarea>
                                    </div>
                                </div>

                                <div id="mcq-document-input" style="display: none;">
                                    <div class="form-group">
                                        <label>Upload File</label>
                                        <input type="file" id="mcq_file_input" accept=".pdf,.csv,.txt,.docx"
                                            style="padding: 10px;">
                                        <div id="mcq_file_name" style="margin-top: 10px; color: var(--text-secondary);">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="mcq_title">Test Title</label>
                                    <input type="text" id="mcq_title" placeholder="e.g., Physics Fundamentals Test"
                                        value="">
                                </div>

                                <div class="form-group">
                                    <label for="mcq_provider_select">AI Provider</label>
                                    <select id="mcq_provider_select">
                                        <option value="gemini" selected>Gemini 2.5 Flash</option>
                                        <option value="groq">Groq (Llama 3.1 70B)</option>
                                    </select>
                                </div>

                                <button class="btn btn-primary" onclick="uploadMCQContent()">Next →</button>

                                <!-- Topic Options -->
                                <div id="mcq-topic-options" style="display: none; margin-top: 30px;">
                                    <h3 style="margin-bottom: 20px;">Configure Questions</h3>
                                    <div class="form-group">
                                        <label for="mcq_num_questions">Number of Questions</label>
                                        <input type="number" id="mcq_num_questions" min="1" max="50" value="5">
                                    </div>
                                    <div class="form-group">
                                        <label for="mcq_subcategory">Subcategory (Optional)</label>
                                        <input type="text" id="mcq_subcategory"
                                            placeholder="e.g., Heisenberg Uncertainty Principle">
                                    </div>
                                    <div class="form-group">
                                        <label for="mcq_difficulty">Difficulty Level</label>
                                        <select id="mcq_difficulty">
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="mcq_option_difficulty">Options Type</label>
                                        <select id="mcq_option_difficulty">
                                            <option value="identifiable">Easily Identifiable</option>
                                            <option value="hard">Hard to Identify (Tricky)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="mcq_marks_per_question">Marks per Question</label>
                                        <input type="number" id="mcq_marks_per_question" min="0.5" max="10" step="0.5"
                                            value="1.0">
                                        <small style="color: var(--text-secondary); font-size: 0.85rem;">Total marks
                                            will be calculated automatically</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="mcq_time_limit">Time Limit</label>
                                        <select id="mcq_time_limit">
                                            <option value="20">20 minutes</option>
                                            <option value="30">30 minutes</option>
                                            <option value="60" selected>1 hour</option>
                                            <option value="120">2 hours</option>
                                            <option value="180">3 hours</option>
                                            <option value="240">4 hours</option>
                                            <option value="300">5 hours</option>
                                        </select>
                                        <small style="color: var(--text-secondary); font-size: 0.85rem;">Test will
                                            auto-submit when time expires</small>
                                    </div>
                                    <button class="btn btn-primary" onclick="generateTestMCQs()">Generate MCQs</button>
                                </div>

                                <!-- Document Options -->
                                <div id="mcq-document-options" style="display: none; margin-top: 30px;">
                                    <h3 style="margin-bottom: 20px;">Configure Questions</h3>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 600;">Question
                                            Count</label>
                                        <div
                                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                            <label
                                                style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.3s; min-width: 150px;"
                                                onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='var(--accent-color)'"
                                                onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                                                <input type="radio" name="mcqQuestionCount" value="specific" checked
                                                    onchange="toggleMCQQuestionCount()"
                                                    style="margin: 0; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;">
                                                <span style="font-size: 0.95rem; white-space: nowrap;">Specific
                                                    Number</span>
                                            </label>
                                            <label
                                                style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.3s; min-width: 150px;"
                                                onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='var(--accent-color)'"
                                                onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                                                <input type="radio" name="mcqQuestionCount" value="max"
                                                    onchange="toggleMCQQuestionCount()"
                                                    style="margin: 0; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;">
                                                <span style="font-size: 0.95rem; white-space: nowrap;">As Many As
                                                    Possible</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group" id="mcq_specific_count_input">
                                        <label for="mcq_doc_num_questions">Number of Questions</label>
                                        <input type="number" id="mcq_doc_num_questions" min="1" max="100" value="10">
                                    </div>
                                    <div class="form-group">
                                        <label for="mcq_doc_marks_per_question">Marks per Question</label>
                                        <input type="number" id="mcq_doc_marks_per_question" min="0.5" max="10"
                                            step="0.5" value="1.0">
                                        <small style="color: var(--text-secondary); font-size: 0.85rem;">Total marks
                                            will be calculated automatically</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="mcq_doc_time_limit">Time Limit</label>
                                        <select id="mcq_doc_time_limit">
                                            <option value="20">20 minutes</option>
                                            <option value="30">30 minutes</option>
                                            <option value="60" selected>1 hour</option>
                                            <option value="120">2 hours</option>
                                            <option value="180">3 hours</option>
                                            <option value="240">4 hours</option>
                                            <option value="300">5 hours</option>
                                        </select>
                                        <small style="color: var(--text-secondary); font-size: 0.85rem;">Test will
                                            auto-submit when time expires</small>
                                    </div>
                                    <button class="btn btn-primary" onclick="generateTestMCQs()">Generate MCQs</button>
                                </div>

                                <div id="mcq-loading" style="display: none; text-align: center; padding: 40px;">
                                    <div class="spinner"
                                        style="border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;">
                                    </div>
                                    <p>Generating MCQs with Gemini AI...</p>
                                </div>

                                <div id="mcq-results-display" style="display: none; margin-top: 30px;"></div>
                            </div>

                            <!-- My MCQs Tab -->
                            <div id="mcq-list-tab" class="mcq-subtab" style="display: none;">
                                <div
                                    style="display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid var(--glass-border);">
                                    <button class="tab-btn active" onclick="switchMCQListTab('tests')"
                                        style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid var(--accent-color); color: var(--accent-color); font-size: 1rem; font-weight: 500; cursor: pointer;">My
                                        Tests</button>
                                    <button class="tab-btn" onclick="switchMCQListTab('scores')"
                                        style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-size: 1rem; font-weight: 500; cursor: pointer;">Learner
                                        Scores</button>
                                </div>

                                <div id="mcq-tests-list" class="mcq-list-subtab" style="display: block;">
                                    <div id="mcq-list-container">
                                        <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                            Loading...</p>
                                    </div>
                                </div>

                                <div id="mcq-scores-list" class="mcq-list-subtab" style="display: none;">
                                    <div class="form-group">
                                        <label for="mcq_scores_test_select">Select Test</label>
                                        <select id="mcq_scores_test_select" onchange="loadMCQScores()">
                                            <option value="">Choose a test...</option>
                                        </select>
                                    </div>
                                    <div id="mcq-scores-container" style="margin-top: 20px;">
                                        <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                            Select a test to view scores</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DIAGRAM EVALUATION TAB -->
                    <div id="diagram-evaluation" class="tab-content">
                        <h1><i class="fas fa-draw-polygon"></i> Diagram Evaluation</h1>
                        <p class="text-secondary mb-30">Create and manage diagram assignments for your courses</p>

                        <div
                            style="display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid var(--glass-border);">
                            <button class="tab-btn" onclick="switchDiagramTab('create')"
                                style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-size: 1rem; font-weight: 500; cursor: pointer;">Create
                                Assignment</button>
                            <button class="tab-btn" onclick="switchDiagramTab('assignments')"
                                style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-size: 1rem; font-weight: 500; cursor: pointer;">My
                                Assignments</button>
                            <button class="tab-btn active" onclick="switchDiagramTab('submissions')"
                                style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid var(--accent-color); color: var(--accent-color); font-size: 1rem; font-weight: 500; cursor: pointer;">View
                                Submissions</button>
                        </div>

                        <!-- Create Assignment -->
                        <div id="diagram-create-tab" class="diagram-subtab" style="display: none;">
                            <div class="card glass-strong">
                                <h2>Create New Diagram Assignment</h2>
                                <form id="createDiagramAssignmentForm">
                                    <div class="form-group">
                                        <label for="diagram_course_id"><i class="fas fa-book"></i> Select Course
                                            *</label>
                                        <select id="diagram_course_id" name="course_id" required>
                                            <option value="">-- Select a Course --</option>
                                            {% for course in courses %}
                                            <option value="{{ course.id }}">{{ course.course_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="diagram_topic"><i class="fas fa-tag"></i> Topic Name *</label>
                                        <input type="text" id="diagram_topic" name="topic" required
                                            placeholder="e.g., Flowchart, Human Body Parts, Pie Chart, Water Cycle">
                                    </div>
                                    <div class="form-group">
                                        <label for="diagram_description"><i class="fas fa-align-left"></i> Description
                                            (Optional)</label>
                                        <textarea id="diagram_description" name="description"
                                            placeholder="Additional instructions for learners..."
                                            style="min-height: 120px;">Please create a clear and detailed diagram for this topic. Make sure to:
- Include all key components and elements
- Use proper labels and annotations
- Ensure the diagram is neat and readable
- Follow standard conventions for this type of diagram

You can edit or remove this default text as needed.</textarea>
                                    </div>
                                    <div id="diagram-form-errors"
                                        style="display: none; margin-top: 15px; padding: 12px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plus-circle"></i> Create Assignment
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- My Assignments -->
                        <div id="diagram-assignments-tab" class="diagram-subtab" style="display: none;">
                            <div class="card glass-strong">
                                <h2>My Diagram Assignments</h2>
                                {% if not diagram_assignments or diagram_assignments|length == 0 %}
                                <p style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-inbox"
                                        style="font-size: 3rem; opacity: 0.5; margin-bottom: 15px; display: block;"></i>
                                    No assignments created yet. Create your first assignment above!
                                </p>
                                {% else %}
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                                    {% for assignment in diagram_assignments %}
                                    <div class="card glass" style="padding: 20px;">
                                        <h3>{{ assignment.topic }}</h3>
                                        <p><strong>Course:</strong> {{ assignment.course.course_name }}</p>
                                        {% if assignment.description %}
                                        <p>{{ assignment.description[:100] }}{% if assignment.description|length > 100
                                            %}...{% endif %}</p>
                                        {% endif %}
                                        <button class="btn btn-primary mt-20"
                                            onclick="viewDiagramSubmissions({{ assignment.id }})">
                                            <i class="fas fa-eye"></i> View Submissions
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Submissions -->
                        <div id="diagram-submissions-tab" class="diagram-subtab" style="display: block;">
                            <div class="card glass-strong">
                                <h2>Diagram Submissions</h2>
                                <div class="form-group">
                                    <label for="diagram_assignment_filter">Filter by Assignment</label>
                                    <select id="diagram_assignment_filter" onchange="loadDiagramSubmissions()">
                                        <option value="">All Assignments</option>
                                        {% for assignment in diagram_assignments %}
                                        <option value="{{ assignment.id }}">{{ assignment.topic }} - {{
                                            assignment.course.course_name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-primary mt-20" onclick="downloadDiagramPDF()"
                                        id="downloadPdfBtn" style="display: none;">
                                        <i class="fas fa-download"></i> Download PDF Report
                                    </button>
                                </div>
                                <div id="diagram-submissions-container">
                                    {% if not diagram_submissions or diagram_submissions|length == 0 %}
                                    <p style="text-align: center; padding: 40px; color: var(--text-muted);">
                                        <i class="fas fa-inbox"
                                            style="font-size: 3rem; opacity: 0.5; margin-bottom: 15px; display: block;"></i>
                                        No submissions yet. Learners can submit diagrams from their dashboard.
                                    </p>
                                    {% else %}
                                    <div id="diagram-submissions-grid"
                                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 25px;">
                                        {% for submission in diagram_submissions %}
                                        <div class="card glass" style="padding: 20px; display: block;"
                                            data-assignment-id="{{ submission.assignment_id }}">
                                            <div
                                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid var(--glass-border);">
                                                <div>
                                                    <strong>{{ submission.learner.full_name or
                                                        submission.learner.username }}</strong><br>
                                                    <small>{{ submission.learner.email }}</small>
                                                </div>
                                                <span
                                                    style="padding: 8px 16px; border-radius: 25px; background: {% if submission.final_marks >= 70 %}#48bb78{% elif submission.final_marks >= 50 %}#ed8936{% else %}#f56565{% endif %}; color: white; font-weight: 700; font-size: 1.1rem;">
                                                    {{ "%.1f"|format(submission.final_marks) }}/100
                                                </span>
                                            </div>
                                            <div style="margin-bottom: 10px;">
                                                <strong>Assignment:</strong> {{ submission.assignment.topic }}
                                            </div>
                                            <img src="{{ url_for('serve_diagram', filename=submission.diagram_path.split('/')[-1]) }}"
                                                style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 10px; margin: 15px 0; border: 2px solid var(--glass-border);"
                                                alt="Diagram">
                                            <div
                                                style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 15px 0;">
                                                <div
                                                    style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                                                    <div><strong>Topic Match:</strong> {{
                                                        "%.1f"|format(submission.topic_match_score) }}/30</div>
                                                    <div><strong>Accuracy:</strong> {{
                                                        "%.1f"|format(submission.accuracy_score) }}/25</div>
                                                    <div><strong>Structure:</strong> {{
                                                        "%.1f"|format(submission.structure_score) }}/20</div>
                                                    <div><strong>Visual:</strong> {{
                                                        "%.1f"|format(submission.visual_score) }}/15</div>
                                                </div>
                                                <div style="margin-top: 10px;"><strong>Technical:</strong> {{
                                                    "%.1f"|format(submission.technical_score) }}/10</div>
                                            </div>
                                            <div
                                                style="padding: 12px; background: {% if submission.is_hand_drawn %}#d4edda{% else %}#f8d7da{% endif %}; border-radius: 8px; border-left: 4px solid {% if submission.is_hand_drawn %}#28a745{% else %}#dc3545{% endif %}; margin: 15px 0;">
                                                <strong>Status:</strong> {{ submission.marks_status or 'Evaluated'
                                                }}<br>
                                                <small>{% if submission.is_hand_drawn %}<i
                                                        class="fas fa-pencil-alt"></i> Hand-Drawn{% else %}<i
                                                        class="fas fa-print"></i> Printed/Digital{% endif %}</small>
                                            </div>
                                            <button class="btn btn-primary"
                                                onclick="viewDiagramDetail({{ submission.id }})">
                                                <i class="fas fa-eye"></i> View Details
                                            </button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <script>
            // Diagram Evaluation Functions
            function switchDiagramTab(tab) {
                document.querySelectorAll('.diagram-subtab').forEach(t => t.style.display = 'none');
                document.querySelectorAll('#diagram-evaluation .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = 'var(--text-secondary)';
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                    event.target.style.borderBottomColor = 'var(--accent-color)';
                    event.target.style.color = 'var(--accent-color)';
                }
                document.getElementById('diagram-' + tab + '-tab').style.display = 'block';

                // If switching to submissions tab, refresh the filter
                if (tab === 'submissions') {
                    loadDiagramAssignments().then(() => {
                        setTimeout(loadDiagramSubmissions, 100);
                    });
                }
            }

            async function loadDiagramAssignments() {
                const filterSelect = document.getElementById('diagram_assignment_filter');
                if (!filterSelect) return;

                try {
                    const response = await fetch('/guide/diagram-evaluation/submissions');
                    const data = await response.json();

                    if (data.success && data.assignments) {
                        filterSelect.innerHTML = '<option value="">All Assignments</option>' +
                            data.assignments.map(a => `<option value="${a.id}">${a.topic} - ${a.course_name}</option>`).join('');
                    }
                } catch (error) {
                    console.error('Error loading assignments:', error);
                }
            }

            async function loadDiagramSubmissions() {
                const filterSelect = document.getElementById('diagram_assignment_filter');
                if (!filterSelect) return;

                const assignmentId = filterSelect.value;
                const pdfBtn = document.getElementById('downloadPdfBtn');
                const container = document.getElementById('diagram-submissions-container');
                if (!container) return;

                // Show loading
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">Loading submissions...</p>';

                try {
                    // Build API URL
                    let url = '/guide/diagram-evaluation/submissions';
                    if (assignmentId) {
                        url += `?assignment_id=${assignmentId}`;
                        if (pdfBtn) pdfBtn.style.display = 'inline-block';
                    } else {
                        if (pdfBtn) pdfBtn.style.display = 'none';
                    }

                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.success && data.submissions && data.submissions.length > 0) {
                        // Render submissions
                        const gridHtml = `
                            <div id="diagram-submissions-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 25px;">
                                ${data.submissions.map(s => `
                                    <div class="card glass" style="padding: 20px;" data-assignment-id="${s.assignment_id || ''}">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid var(--glass-border);">
                                            <div>
                                                <strong>${s.learner_name || 'Unknown'}</strong><br>
                                                <small>${s.learner_email || ''}</small>
                                            </div>
                                            <span style="padding: 8px 16px; border-radius: 25px; background: ${s.final_marks >= 70 ? '#48bb78' : s.final_marks >= 50 ? '#ed8936' : '#f56565'}; color: white; font-weight: 700; font-size: 1.1rem;">
                                                ${s.final_marks ? s.final_marks.toFixed(1) : '0'}/100
                                            </span>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong>Assignment:</strong> ${s.assignment_topic || 'N/A'}
                                        </div>
                                        <img src="/diagram-uploads/${s.diagram_path ? s.diagram_path.split('/').pop() : ''}" 
                                             style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 10px; margin: 15px 0; border: 2px solid var(--glass-border);"
                                             alt="Diagram" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23ddd%22 width=%22400%22 height=%22300%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2214%22 dy=%2210.5%22 font-weight=%22bold%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22%3EImage not found%3C/text%3E%3C/svg%3E';">
                                        <div style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 15px 0;">
                                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                                                <div><strong>Status:</strong> ${s.marks_status || 'Evaluated'}</div>
                                                <div><strong>Type:</strong> ${s.is_hand_drawn ? '<i class="fas fa-pencil-alt"></i> Hand-Drawn' : '<i class="fas fa-print"></i> Digital'}</div>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" onclick="viewDiagramDetail(${s.id})">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        container.innerHTML = gridHtml;
                    } else {
                        container.innerHTML = `
                            <p style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.5; margin-bottom: 15px; display: block;"></i>
                                No submissions found${assignmentId ? ' for this assignment' : ''}.
                            </p>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading diagram submissions:', error);
                    container.innerHTML = `
                        <p style="text-align: center; padding: 40px; color: var(--error);">
                            Error loading submissions. Please try again.
                        </p>
                    `;
                }
            }

            function viewDiagramSubmissions(assignmentId) {
                const filterSelect = document.getElementById('diagram_assignment_filter');
                if (filterSelect) {
                    // Load assignments first, then set value
                    loadDiagramAssignments().then(() => {
                        filterSelect.value = assignmentId;
                        switchDiagramTab('submissions');
                        setTimeout(() => {
                            loadDiagramSubmissions();
                        }, 200);
                    });
                } else {
                    switchDiagramTab('submissions');
                    setTimeout(() => {
                        loadDiagramAssignments().then(() => {
                            filterSelect.value = assignmentId;
                            loadDiagramSubmissions();
                        });
                    }, 200);
                }
            }

            function viewDiagramDetail(submissionId) {
                fetch(`/guide/diagram-evaluation/submission/${submissionId}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            const s = data.submission;
                            alert(`Submission Details:\n\nLearner: ${s.learner_name}\nScore: ${s.final_marks}/100\nStatus: ${s.marks_status}\n\nTopic Match: ${s.topic_match_score}/30\nAccuracy: ${s.accuracy_score}/25\nStructure: ${s.structure_score}/20\nVisual: ${s.visual_score}/15\nTechnical: ${s.technical_score}/10`);
                        }
                    });
            }

            function downloadDiagramPDF() {
                const assignmentId = document.getElementById('diagram_assignment_filter').value;
                if (assignmentId) {
                    window.location.href = `/guide/diagram-evaluation/download-pdf/${assignmentId}`;
                }
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function () {
                // Load assignments dropdown when diagram tab is active
                const diagramTab = document.getElementById('diagram-evaluation');
                if (diagramTab && diagramTab.style.display !== 'none') {
                    loadDiagramAssignments().then(() => {
                        loadDiagramSubmissions();
                    });
                }

                // Load MCQ list when MCQ tab is active
                const mcqTab = document.getElementById('test-mcq-gen');
                if (mcqTab && mcqTab.style.display !== 'none') {
                    loadCoursesForMCQ();
                    loadMCQList();
                }
            });

            // ============= TEST MCQ GENERATION FUNCTIONS =============
            let uploadedMCQContent = null;
            let uploadedMCQType = null;
            let uploadedMCQFilename = null;
            const MCQ_EDITOR_MAX_OPTIONS = 6;
            let mcqEditorState = {
                testId: null,
                mcqs: []
            };

            function switchMCQTab(tab) {
                document.querySelectorAll('.mcq-subtab').forEach(t => t.style.display = 'none');
                document.querySelectorAll('#test-mcq-gen .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = 'var(--text-secondary)';
                });

                if (event && event.target) {
                    event.target.classList.add('active');
                    event.target.style.borderBottomColor = 'var(--accent-color)';
                    event.target.style.color = 'var(--accent-color)';
                }

                document.getElementById('mcq-' + tab + '-tab').style.display = 'block';

                if (tab === 'create') {
                    // Load courses when switching to create tab
                    setTimeout(() => loadCoursesForMCQ(), 100);
                } else if (tab === 'list') {
                    loadMCQList();
                    loadMCQTestsForScores();
                }
            }

            function switchMCQListTab(tab) {
                document.querySelectorAll('.mcq-list-subtab').forEach(t => t.style.display = 'none');
                document.querySelectorAll('#mcq-list-tab .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = 'var(--text-secondary)';
                });

                if (event && event.target) {
                    event.target.classList.add('active');
                    event.target.style.borderBottomColor = 'var(--accent-color)';
                    event.target.style.color = 'var(--accent-color)';
                }

                document.getElementById('mcq-' + tab + '-list').style.display = 'block';

                if (tab === 'scores') {
                    loadMCQTestsForScores();
                }
            }

            function toggleMCQInput() {
                const inputType = document.querySelector('input[name="mcqInputType"]:checked').value;
                if (inputType === 'topic') {
                    document.getElementById('mcq-topic-input').style.display = 'block';
                    document.getElementById('mcq-document-input').style.display = 'none';
                } else {
                    document.getElementById('mcq-topic-input').style.display = 'none';
                    document.getElementById('mcq-document-input').style.display = 'block';
                }
            }

            function toggleMCQQuestionCount() {
                const countType = document.querySelector('input[name="mcqQuestionCount"]:checked').value;
                document.getElementById('mcq_specific_count_input').style.display =
                    countType === 'specific' ? 'block' : 'none';
            }

            async function loadCoursesForMCQ() {
                const select = document.getElementById('mcq_course_select');
                if (!select) return;

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const response = await fetch('/guide/courses', {
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    });
                    const data = await response.json();

                    select.innerHTML = '<option value="">Choose a course...</option>';

                    if (data.success && data.courses && data.courses.length > 0) {
                        data.courses.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course.id;
                            option.textContent = course.name || course.course_name;
                            select.appendChild(option);
                        });
                    } else {
                        select.innerHTML = '<option value="">No courses available</option>';
                    }
                } catch (error) {
                    console.error('Error loading courses:', error);
                    select.innerHTML = '<option value="">Error loading courses</option>';
                }
            }


            document.getElementById('mcq_file_input')?.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('mcq_file_name').textContent = 'Selected: ' + file.name;
                }
            });

            async function uploadMCQContent() {
                const inputType = document.querySelector('input[name="mcqInputType"]:checked').value;
                const title = document.getElementById('mcq_title').value.trim();

                if (!title) {
                    alert('Please enter a test title');
                    return;
                }

                const formData = new FormData();
                formData.append('inputType', inputType);

                if (inputType === 'topic') {
                    const topicText = document.getElementById('mcq_topic_text').value.trim();
                    if (!topicText) {
                        alert('Please enter a topic');
                        return;
                    }
                    formData.append('topicText', topicText);
                } else {
                    const fileInput = document.getElementById('mcq_file_input');
                    if (!fileInput.files[0]) {
                        alert('Please select a file');
                        return;
                    }
                    formData.append('file', fileInput.files[0]);
                }

                try {
                    // Get CSRF token from meta tag
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

                    const response = await fetch('/guide/test-mcq/upload', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    });

                    const data = await response.json();

                    if (!data.success) {
                        alert('Error: ' + (data.error || 'Upload failed'));
                        return;
                    }

                    uploadedMCQContent = data.content;
                    uploadedMCQType = data.type;
                    uploadedMCQFilename = data.filename;

                    if (data.type === 'topic') {
                        document.getElementById('mcq-topic-options').style.display = 'block';
                    } else {
                        document.getElementById('mcq-document-options').style.display = 'block';
                    }
                } catch (error) {
                    alert('Error uploading content: ' + error.message);
                }
            }

            async function generateTestMCQs() {
                const courseId = document.getElementById('mcq_course_select').value;
                if (!courseId) {
                    alert('Please select a course');
                    document.getElementById('mcq_course_select').focus();
                    return;
                }

                const title = document.getElementById('mcq_title').value.trim();
                if (!title) {
                    alert('Please enter a test title');
                    return;
                }

                document.getElementById('mcq-topic-options').style.display = 'none';
                document.getElementById('mcq-document-options').style.display = 'none';
                document.getElementById('mcq-loading').style.display = 'block';
                document.getElementById('mcq-results-display').style.display = 'none';

                const requestData = {
                    content: uploadedMCQContent,
                    type: uploadedMCQType,
                    title: title,
                    courseId: courseId,
                    provider: document.getElementById('mcq_provider_select').value
                };

                if (uploadedMCQType === 'topic') {
                    requestData.numQuestions = parseInt(document.getElementById('mcq_num_questions').value);
                    requestData.subcategory = document.getElementById('mcq_subcategory').value;
                    requestData.difficulty = document.getElementById('mcq_difficulty').value;
                    requestData.optionDifficulty = document.getElementById('mcq_option_difficulty').value;
                    requestData.marksPerQuestion = parseFloat(document.getElementById('mcq_marks_per_question').value) || 1.0;
                    requestData.timeLimitMinutes = parseInt(document.getElementById('mcq_time_limit').value) || 60;
                } else {
                    const questionCount = document.querySelector('input[name="mcqQuestionCount"]:checked').value;
                    requestData.maxQuestions = questionCount === 'max';
                    if (questionCount === 'specific') {
                        requestData.numQuestions = parseInt(document.getElementById('mcq_doc_num_questions').value);
                    }
                    requestData.marksPerQuestion = parseFloat(document.getElementById('mcq_doc_marks_per_question').value) || 1.0;
                    requestData.timeLimitMinutes = parseInt(document.getElementById('mcq_doc_time_limit').value) || 60;
                }

                try {
                    // Get CSRF token from meta tag
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

                    const response = await fetch('/guide/test-mcq/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(requestData)
                    });

                    const data = await response.json();

                    document.getElementById('mcq-loading').style.display = 'none';

                    if (!data.success) {
                        alert('Error: ' + (data.error || 'Generation failed'));
                        return;
                    }

                    // MCQ is already saved in database, now redirect to scores view
                    // Switch to "My MCQs" tab
                    switchMCQTab('list');

                    // Wait a bit for tab to switch, then switch to scores tab
                    setTimeout(() => {
                        switchMCQListTab('scores');
                        // Load tests and select the newly created one
                        loadMCQTestsForScores().then(() => {
                            if (data.test_id) {
                                document.getElementById('mcq_scores_test_select').value = data.test_id;
                                loadMCQScores();
                            }
                        });
                    }, 300);
                } catch (error) {
                    document.getElementById('mcq-loading').style.display = 'none';
                    alert('Error generating MCQs: ' + error.message);
                }
            }

            // Removed displayGeneratedMCQs - now redirects directly to scores

            function resetMCQForm() {
                uploadedMCQContent = null;
                uploadedMCQType = null;
                uploadedMCQFilename = null;
                document.getElementById('mcq_topic_text').value = '';
                document.getElementById('mcq_file_input').value = '';
                document.getElementById('mcq_file_name').textContent = '';
                document.getElementById('mcq_title').value = '';
                document.getElementById('mcq-topic-options').style.display = 'none';
                document.getElementById('mcq-document-options').style.display = 'none';
                document.getElementById('mcq-results-display').style.display = 'none';
            }

            async function loadMCQList() {
                const container = document.getElementById('mcq-list-container');
                if (!container) return;

                try {
                    const response = await fetch('/guide/test-mcq/list');
                    const data = await response.json();

                    if (data.success && data.mcqs && data.mcqs.length > 0) {
                        container.innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                                ${data.mcqs.map(mcq => `
                                    <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent-color);">
                                        <h4 style="margin-bottom: 10px;">${mcq.title}</h4>
                                        <p style="color: var(--text-secondary); margin-bottom: 10px;">
                                            <strong>Type:</strong> ${mcq.source_type}<br>
                                            <strong>Questions:</strong> ${mcq.num_questions}<br>
                                            <strong>Total Marks:</strong> ${mcq.total_marks || mcq.num_questions}<br>
                                            <strong>Created:</strong> ${new Date(mcq.created_at).toLocaleDateString()}
                                        </p>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            <button class="btn btn-outline" onclick="showGeneratedMCQPreview(${mcq.id})">View Generated MCQs</button>
                                            <button class="btn btn-primary" onclick="switchToScoresTab(${mcq.id})">Learner Scores</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">No MCQ tests created yet.</p>';
                    }
                } catch (error) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--error);">Error loading MCQ list.</p>';
                }
            }

            async function showGeneratedMCQPreview(testId) {
                const modal = document.getElementById('mcq-preview-modal');
                const body = modal.querySelector('.modal-body');
                const title = modal.querySelector('.modal-title');
                modal.style.display = 'flex';
                title.textContent = 'Loading MCQs...';
                body.innerHTML = '<p style="text-align:center;">Loading...</p>';

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const response = await fetch(`/guide/test-mcq/${testId}/details`, {
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    });
                    const data = await response.json();

                    if (!data.success) {
                        title.textContent = 'Error';
                        body.innerHTML = `<p style="color: var(--error); text-align:center;">${data.error || 'Unable to load MCQs.'}</p>`;
                        return;
                    }

                    title.textContent = data.test.title;
                    mcqEditorState.testId = testId;
                    mcqEditorState.mcqs = (data.mcqs || []).map(normalizeMCQForEditor);

                    body.innerHTML = `
                        <div id="mcq-editor-status" style="display:none; margin-bottom:15px; font-weight:600;"></div>
                        <div id="mcq-editor-list"></div>
                        <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-top:20px;">
                            <button class="btn btn-outline" type="button" onclick="addMCQQuestion()">+ Add question</button>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-primary" type="button" onclick="saveMCQEdits()">Save changes</button>
                                <button class="btn btn-outline" type="button" onclick="renderMCQEditor()">Refresh editor</button>
                            </div>
                        </div>
                    `;

                    renderMCQEditor();
                } catch (error) {
                    title.textContent = 'Error';
                    body.innerHTML = `<p style="color: var(--error); text-align:center;">${error.message}</p>`;
                }
            }

            function normalizeMCQForEditor(mcq) {
                const question = mcq.question || '';
                const options = Array.isArray(mcq.options) ? mcq.options : [];
                const answer = (mcq.answer || '').toUpperCase();
                const normalizedOptions = [];
                for (let i = 0; i < Math.max(options.length, 4); i++) {
                    normalizedOptions.push(stripOptionPrefix(options[i] || ''));
                }
                return {
                    question,
                    options: normalizedOptions,
                    answer: answer || 'A',
                    explanation: mcq.explanation || ''
                };
            }

            function stripOptionPrefix(option) {
                if (!option) return '';
                const closingBracket = option.indexOf(')');
                if (closingBracket !== -1) {
                    return option.slice(closingBracket + 1).trim();
                }
                return option;
            }

            function renderMCQEditor() {
                const container = document.getElementById('mcq-editor-list');
                const status = document.getElementById('mcq-editor-status');
                if (status) {
                    status.style.display = 'none';
                    status.textContent = '';
                }

                if (!container) return;
                if (!mcqEditorState.mcqs.length) {
                    container.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">No questions available yet. Use "Add question" to insert one.</p>';
                    return;
                }

                container.innerHTML = mcqEditorState.mcqs.map((mcq, index) => {
                    const optionFields = [];
                    const optionCount = Math.min(Math.max(mcq.options.length, 4), MCQ_EDITOR_MAX_OPTIONS);
                    for (let optIdx = 0; optIdx < optionCount; optIdx++) {
                        const letter = String.fromCharCode(65 + optIdx);
                        const optionValue = mcq.options[optIdx] || '';
                        optionFields.push(`
                            <div class="mcq-option-row" style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                                <span style="min-width:20px; font-weight:600;">${letter}</span>
                                <input type="text" class="mcq-option-text" value="${escapeHTML(optionValue)}" placeholder="Option ${letter}" style="flex:1; padding:8px 12px; border-radius:6px; border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.05); color:white;">
                                <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                                    <input type="radio" name="correct-option-${index}" value="${letter}" ${mcq.answer === letter ? 'checked' : ''}>
                                    Correct
                                </label>
                            </div>
                        `);
                    }

                    return `
                        <div class="mcq-edit-card" data-index="${index}" style="border:1px solid rgba(255,255,255,0.1); padding:16px; border-radius:12px; margin-bottom:16px; background:rgba(15,23,42,0.85);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <strong>Question ${index + 1}</strong>
                                <button type="button" class="btn btn-outline" style="font-size:0.8rem;" onclick="removeMCQQuestion(${index})">Remove</button>
                            </div>
                            <textarea class="mcq-edit-question" rows="2" placeholder="Question text" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.05); color:white; margin-bottom:12px;">${escapeHTML(mcq.question)}</textarea>
                            <div>${optionFields.join('')}</div>
                            <textarea class="mcq-edit-explanation" rows="2" placeholder="Explanation (optional)" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.05); color:white; margin-top:8px;">${escapeHTML(mcq.explanation)}</textarea>
                        </div>
                    `;
                }).join('');
            }

            function addMCQQuestion() {
                mcqEditorState.mcqs.push({
                    question: '',
                    options: ['', '', '', ''],
                    answer: 'A',
                    explanation: ''
                });
                renderMCQEditor();
            }

            function removeMCQQuestion(index) {
                if (mcqEditorState.mcqs.length <= 1) {
                    alert('At least one question must remain.');
                    return;
                }
                mcqEditorState.mcqs.splice(index, 1);
                renderMCQEditor();
            }

            function escapeHTML(text) {
                if (text === undefined || text === null) return '';
                return text.toString()
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            async function saveMCQEdits() {
                const container = document.getElementById('mcq-editor-list');
                const status = document.getElementById('mcq-editor-status');
                if (!container || !status) return;

                const cards = container.querySelectorAll('.mcq-edit-card');
                if (!cards.length) {
                    status.textContent = 'Add at least one question before saving.';
                    status.style.color = '#f87171';
                    status.style.display = 'block';
                    return;
                }

                const payload = [];
                for (let idx = 0; idx < cards.length; idx++) {
                    const card = cards[idx];
                    const questionText = card.querySelector('.mcq-edit-question')?.value.trim() || '';
                    if (!questionText) {
                        status.textContent = `Question ${idx + 1} cannot be empty.`;
                        status.style.color = '#f87171';
                        status.style.display = 'block';
                        return;
                    }

                    const optionInputs = card.querySelectorAll('.mcq-option-text');
                    const optionValues = [];
                    optionInputs.forEach(input => {
                        const value = input.value.trim();
                        if (value) optionValues.push(value);
                    });
                    if (optionValues.length < 2) {
                        status.textContent = `Question ${idx + 1} needs at least 2 options.`;
                        status.style.color = '#f87171';
                        status.style.display = 'block';
                        return;
                    }

                    const correctRadio = card.querySelector(`input[name="correct-option-${idx}"]:checked`);
                    const answer = correctRadio ? correctRadio.value : 'A';
                    const formattedOptions = optionValues.map((opt, optIdx) => `${String.fromCharCode(65 + optIdx)}) ${opt}`);
                    const explanation = card.querySelector('.mcq-edit-explanation')?.value.trim() || '';

                    if (!formattedOptions[answer.charCodeAt(0) - 65]) {
                        status.textContent = `Correct answer for Question ${idx + 1} is invalid.`;
                        status.style.color = '#f87171';
                        status.style.display = 'block';
                        return;
                    }

                    payload.push({
                        question: questionText,
                        options: formattedOptions,
                        answer,
                        explanation
                    });
                }

                try {
                    status.textContent = 'Saving...';
                    status.style.color = '#fcd34d';
                    status.style.display = 'block';

                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const response = await fetch(`/guide/test-mcq/${mcqEditorState.testId}/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ mcqs: payload })
                    });

                    const data = await response.json();
                    if (!data.success) {
                        status.textContent = data.error || 'Failed to save MCQs.';
                        status.style.color = '#f87171';
                        return;
                    }

                    status.textContent = 'MCQs saved successfully.';
                    status.style.color = '#34d399';
                    setTimeout(() => showGeneratedMCQPreview(mcqEditorState.testId), 800);
                } catch (error) {
                    status.textContent = 'Save failed: ' + error.message;
                    status.style.color = '#f87171';
                }
            }
            function closeMCQPreviewModal() {
                document.getElementById('mcq-preview-modal').style.display = 'none';
            }

            function switchToScoresTab(testId) {
                switchMCQTab('list');
                setTimeout(() => {
                    const select = document.getElementById('mcq_scores_test_select');
                    if (select) {
                        select.value = testId;
                        loadMCQScores();
                    }
                    switchMCQListTab('scores');
                }, 350);
            }

            async function loadMCQTestsForScores() {
                const select = document.getElementById('mcq_scores_test_select');
                if (!select) return Promise.resolve();

                try {
                    const response = await fetch('/guide/test-mcq/list');
                    const data = await response.json();

                    select.innerHTML = '<option value="">Choose a test...</option>';

                    if (data.success && data.mcqs && data.mcqs.length > 0) {
                        data.mcqs.forEach(mcq => {
                            const option = document.createElement('option');
                            option.value = mcq.id;
                            option.textContent = `${mcq.title} (${mcq.num_questions} questions, ${mcq.total_marks || mcq.num_questions} marks)`;
                            select.appendChild(option);
                        });
                    }
                    return Promise.resolve();
                } catch (error) {
                    console.error('Error loading tests:', error);
                    return Promise.resolve();
                }
            }

            async function loadMCQScores() {
                const testId = document.getElementById('mcq_scores_test_select').value;
                const container = document.getElementById('mcq-scores-container');

                if (!testId) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">Select a test to view scores</p>';
                    return;
                }

                container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">Loading scores...</p>';

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const response = await fetch(`/guide/test-mcq/${testId}/scores`, {
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    });
                    const data = await response.json();

                    if (!data.success) {
                        container.innerHTML = `<p style="text-align: center; padding: 40px; color: var(--error);">Error: ${data.error || 'Failed to load scores'}</p>`;
                        return;
                    }

                    if (data.attempts && data.attempts.length > 0) {
                        const test = data.test;
                        let html = `
                            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <h3 style="margin: 0;">${test.title} - Learner Scores</h3>
                                <button class="btn btn-primary" onclick="downloadMCQScoresPDF(${testId})">
                                    <i class="fas fa-download"></i> Download PDF
                                </button>
                            </div>
                            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent-color);">${data.attempts.length}</div>
                                        <div style="color: var(--text-secondary);">Total Attempts</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${data.average_score ? data.average_score.toFixed(1) : 0}%</div>
                                        <div style="color: var(--text-secondary);">Average Score</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${data.average_marks ? data.average_marks.toFixed(1) : 0}/${test.total_marks || test.num_questions}</div>
                                        <div style="color: var(--text-secondary);">Average Marks</div>
                                    </div>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: var(--glass-bg); border-radius: 12px; overflow: hidden;">
                                    <thead>
                                        <tr style="background: rgba(102, 126, 234, 0.1);">
                                            <th style="padding: 15px; text-align: left; border-bottom: 2px solid var(--glass-border);">Learner Name</th>
                                            <th style="padding: 15px; text-align: center; border-bottom: 2px solid var(--glass-border);">Score %</th>
                                            <th style="padding: 15px; text-align: center; border-bottom: 2px solid var(--glass-border);">Marks</th>
                                            <th style="padding: 15px; text-align: center; border-bottom: 2px solid var(--glass-border);">Correct</th>
                                            <th style="padding: 15px; text-align: center; border-bottom: 2px solid var(--glass-border);">Completed</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.attempts.map(attempt => `
                                            <tr style="border-bottom: 1px solid var(--glass-border);">
                                                <td style="padding: 15px;"><strong>${attempt.learner_name}</strong></td>
                                                <td style="padding: 15px; text-align: center;">
                                                    <span style="color: ${attempt.score >= 70 ? 'var(--success)' : attempt.score >= 50 ? 'var(--warning)' : 'var(--error)'}; font-weight: 600;">
                                                        ${attempt.score.toFixed(1)}%
                                                    </span>
                                                </td>
                                                <td style="padding: 15px; text-align: center;">
                                                    <strong>${attempt.marks_obtained.toFixed(1)}/${attempt.total_marks.toFixed(1)}</strong>
                                                </td>
                                                <td style="padding: 15px; text-align: center;">${attempt.correct_answers}/${attempt.total_questions}</td>
                                                <td style="padding: 15px; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                                                    ${new Date(attempt.completed_at).toLocaleString()}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">No attempts yet for this test.</p>';
                    }
                } catch (error) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--error);">Error loading scores.</p>';
                }
            }

            async function downloadMCQScoresPDF(testId) {
                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const response = await fetch(`/guide/test-mcq/${testId}/scores/pdf`, {
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `mcq-scores-${testId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        alert('Error generating PDF');
                    }
                } catch (error) {
                    alert('Error downloading PDF: ' + error.message);
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                const form = document.getElementById('createDiagramAssignmentForm');
                const errorDiv = document.getElementById('diagram-form-errors');

                if (form) {
                    // Clear errors on input
                    const inputs = form.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.addEventListener('input', function () {
                            if (errorDiv) {
                                errorDiv.style.display = 'none';
                                errorDiv.textContent = '';
                            }
                            // Remove error styling
                            this.style.borderColor = '';
                        });
                    });

                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();

                        // Hide previous errors
                        if (errorDiv) {
                            errorDiv.style.display = 'none';
                            errorDiv.textContent = '';
                        }

                        // Get form elements
                        const courseSelect = document.getElementById('diagram_course_id');
                        const topicInput = document.getElementById('diagram_topic');
                        const descriptionTextarea = document.getElementById('diagram_description');
                        const btn = form.querySelector('button[type="submit"]');
                        const originalText = btn.innerHTML;

                        // Client-side validation
                        if (!courseSelect.value) {
                            showFormError('Please select a course', 'course_id');
                            courseSelect.focus();
                            return;
                        }

                        if (!topicInput.value.trim()) {
                            showFormError('Please enter a topic name', 'topic');
                            topicInput.focus();
                            return;
                        }

                        if (topicInput.value.trim().length < 3) {
                            showFormError('Topic name must be at least 3 characters long', 'topic');
                            topicInput.focus();
                            return;
                        }

                        // Prepare form data
                        const formData = new FormData();
                        formData.append('course_id', courseSelect.value);
                        formData.append('topic', topicInput.value.trim());
                        formData.append('description', descriptionTextarea.value.trim());

                        // Disable button and show loading
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Assignment...';

                        try {
                            const response = await fetch('{{ url_for("create_diagram_assignment") }}', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token() }}'
                                }
                            });

                            const result = await response.json();

                            if (result.success) {
                                // Success - show success message
                                if (errorDiv) {
                                    errorDiv.style.display = 'block';
                                    errorDiv.style.background = '#d4edda';
                                    errorDiv.style.borderColor = '#c3e6cb';
                                    errorDiv.style.color = '#155724';
                                    errorDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + result.message;
                                }

                                // Reset form
                                form.reset();

                                // Restore default description text
                                if (descriptionTextarea) {
                                    descriptionTextarea.value = 'Please create a clear and detailed diagram for this topic. Make sure to:\n- Include all key components and elements\n- Use proper labels and annotations\n- Ensure the diagram is neat and readable\n- Follow standard conventions for this type of diagram\n\nYou can edit or remove this default text as needed.';
                                }

                                // Reload page after 1.5 seconds to show new assignment
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                // Show error message
                                showFormError(result.message || 'Failed to create assignment', result.field || 'general');

                                // Focus on the field with error
                                if (result.field === 'course_id' && courseSelect) {
                                    courseSelect.focus();
                                } else if (result.field === 'topic' && topicInput) {
                                    topicInput.focus();
                                }
                            }
                        } catch (error) {
                            console.error('Error creating assignment:', error);
                            showFormError('Network error: Could not connect to server. Please check your connection and try again.', 'general');
                        } finally {
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }
                    });
                }
            });

            function showFormError(message, field) {
                const errorDiv = document.getElementById('diagram-form-errors');
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#f8d7da';
                    errorDiv.style.borderColor = '#f5c6cb';
                    errorDiv.style.color = '#721c24';
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;

                    // Scroll to error
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }

                // Highlight the field with error
                if (field === 'course_id') {
                    const courseSelect = document.getElementById('diagram_course_id');
                    if (courseSelect) {
                        courseSelect.style.borderColor = '#dc3545';
                    }
                } else if (field === 'topic') {
                    const topicInput = document.getElementById('diagram_topic');
                    if (topicInput) {
                        topicInput.style.borderColor = '#dc3545';
                    }
                }
            }

            // Initialize diagram evaluation on page load
            document.addEventListener('DOMContentLoaded', function () {
                // Initialize submissions display when submissions tab is visible
                setTimeout(() => {
                    const submissionsTab = document.getElementById('diagram-submissions-tab');
                    if (submissionsTab && submissionsTab.style.display !== 'none') {
                        loadDiagramSubmissions();
                    }
                }, 500);

                // Handle diagram-evaluation tab click
                const diagramTab = document.querySelector('a[href="#diagram-evaluation"]');
                if (diagramTab) {
                    diagramTab.addEventListener('click', function () {
                        setTimeout(() => {
                            const submissionsTab = document.getElementById('diagram-submissions-tab');
                            if (submissionsTab && submissionsTab.style.display !== 'none') {
                                loadDiagramSubmissions();
                            }
                        }, 300);
                    });
                }

                // Check on initial load if hash is present
                if (window.location.hash === '#diagram-evaluation') {
                    setTimeout(loadDiagramSubmissions, 800);
                }
            });

            // Display selected file name
            function displayFileName(input) {
                const display = document.getElementById('file-name-display');
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2); // Convert to MB
                    display.innerHTML = `<i class="fas fa-file"></i> Selected: <strong>${file.name}</strong> (${fileSize} MB)`;
                    display.style.color = 'var(--success)';
                } else {
                    display.innerHTML = '';
                }
            }

            // Upload Form Handler
            document.addEventListener('DOMContentLoaded', function () {
                const uploadForm = document.getElementById('uploadForm');

                if (uploadForm) {
                    uploadForm.addEventListener('submit', async function (e) {
                        e.preventDefault();

                        const formData = new FormData(this);
                        const submitBtn = this.querySelector('button[type="submit"]');
                        const originalBtnText = submitBtn.innerHTML;

                        // Validation
                        const fileInput = document.getElementById('file');
                        const courseInput = document.getElementById('course_id');

                        if (!courseInput.value) {
                            showAlert('Please select a course', 'error');
                            return;
                        }

                        if (!fileInput.files || fileInput.files.length === 0) {
                            showAlert('Please select a file', 'error');
                            return;
                        }

                        // Check file size (50MB limit)
                        const file = fileInput.files[0];
                        const maxSize = 50 * 1024 * 1024; // 50MB in bytes

                        if (file.size > maxSize) {
                            showAlert('File size exceeds 50MB limit', 'error');
                            return;
                        }

                        try {
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                            // Get CSRF token
                            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                            const headers = {};
                            if (csrfToken) {
                                headers['X-CSRFToken'] = csrfToken;
                            }

                            const response = await fetch('{{ url_for("guide_upload") }}', {
                                method: 'POST',
                                body: formData,
                                headers: headers
                            });

                            const data = await response.json();

                            if (data.success) {
                                showAlert(data.message, 'success');
                                this.reset();
                                document.getElementById('file-name-display').innerHTML = '';

                                // Reload materials tab if needed
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                showAlert(data.message || 'Upload failed', 'error');
                            }
                        } catch (error) {
                            console.error('Upload error:', error);
                            showAlert('An error occurred during upload', 'error');
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    });
                }
            });

            // ========================================
            // THEME TOGGLE FUNCTIONALITY
            // ========================================

            // Check for saved theme preference or default to 'dark'
            const currentTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);

            // Create theme toggle button if it doesn't exist
            function createThemeToggle() {
                if (document.querySelector('.theme-toggle')) return;

                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'theme-toggle';
                toggleBtn.setAttribute('aria-label', 'Toggle theme');
                toggleBtn.innerHTML = currentTheme === 'dark'
                    ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>';

                document.body.appendChild(toggleBtn);

                // Toggle theme on click
                toggleBtn.addEventListener('click', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    const newTheme = theme === 'light' ? 'dark' : 'light';

                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);

                    // Update button icon with animation
                    toggleBtn.style.transform = 'scale(0.8) rotate(360deg)';

                    setTimeout(() => {
                        toggleBtn.innerHTML = newTheme === 'dark'
                            ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>'
                            : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>';

                        toggleBtn.style.transform = 'scale(1) rotate(0deg)';
                    }, 200);
                });
            }

            // Initialize theme toggle when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', createThemeToggle);
            } else {
                createThemeToggle();
            }

            // ========================================
            // TAB NAVIGATION
            // ========================================

            document.addEventListener('DOMContentLoaded', () => {
                // Tab Navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', function (e) {
                        e.preventDefault();

                        // Remove active class from all tabs and content
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                        // Add active class to clicked tab
                        this.classList.add('active');

                        // Show corresponding content
                        const tabId = this.getAttribute('href').substring(1);
                        document.getElementById(tabId).classList.add('active');

                        // Reset learners section when switching tabs
                        if (tabId !== 'courses') {
                            document.getElementById('learners-section').style.display = 'none';
                            document.querySelector('#courses .user-list').style.display = 'grid';
                        }
                    });
                });

                // View Learners Button
                document.querySelectorAll('.view-learners-btn').forEach(btn => {
                    btn.addEventListener('click', async function () {
                        const courseId = this.getAttribute('data-course-id');
                        const courseName = this.getAttribute('data-course-name');

                        try {
                            const response = await fetch(`/api/course/${courseId}/learners`);
                            const data = await response.json();

                            if (data.success) {
                                // Hide courses list, show learners section
                                document.querySelector('#courses .user-list').style.display = 'none';
                                document.getElementById('learners-section').style.display = 'block';
                                document.getElementById('course-title').textContent = `${courseName} - Learners`;

                                // Populate learners
                                const container = document.getElementById('learners-container');
                                container.innerHTML = '';

                                data.learners.forEach(learner => {
                                    const card = document.createElement('div');
                                    card.className = 'user-card glass';
                                    card.innerHTML = `
                                    ${learner.profile_photo
                                            ? `<img src="${learner.profile_photo}" alt="${learner.full_name}">`
                                            : '<img src="https://via.placeholder.com/80" alt="Profile">'}
                                    <p>${learner.full_name || learner.username}</p>
                                    <p><small>${learner.email}</small></p>
                                    <span class="user-status ${learner.is_online ? 'status-online' : 'status-offline'}"></span>
                                    <a href="{{ url_for('messages') }}" class="btn" style="margin-top: 10px;">Message</a>
                                `;
                                    container.appendChild(card);
                                });
                            }
                        } catch (error) {
                            console.error('Error fetching learners:', error);
                            showAlert('Failed to load learners', 'error');
                        }
                    });
                });

                // Back to Courses Button
                document.getElementById('back-to-courses').addEventListener('click', function () {
                    document.getElementById('learners-section').style.display = 'none';
                    document.querySelector('#courses .user-list').style.display = 'grid';
                });

                // Upload Form
                document.getElementById('uploadForm').addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const formData = new FormData(this);

                    try {
                        const response = await fetch('{{ url_for("guide_upload") }}', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data.success) {
                            showAlert(data.message, 'success');
                            this.reset();

                            // Reload materials tab
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showAlert(data.message, 'error');
                        }
                    } catch (error) {
                        showAlert('An error occurred', 'error');
                    }
                });
            });

            // ========================================
            // ALERT FUNCTION
            // ========================================

            function showAlert(message, type) {
                const alertContainer = document.getElementById('alert-container');
                const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
                alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }

            // ========================================
            // SMOOTH SCROLL ENHANCEMENTS
            // ========================================

            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        const href = this.getAttribute('href');
                        if (href !== '#' && href !== '#!' && !this.classList.contains('nav-tab')) {
                            e.preventDefault();
                            const target = document.querySelector(href);
                            if (target) {
                                target.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'start'
                                });
                            }
                        }
                    });
                });
            });

            // ========================================
            // RIPPLE EFFECT ON BUTTONS
            // ========================================

            function createRipple(event) {
                const button = event.currentTarget;
                const ripple = document.createElement('span');
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;

                ripple.style.width = ripple.style.height = `${diameter}px`;
                ripple.style.left = `${event.clientX - button.offsetLeft - radius}px`;
                ripple.style.top = `${event.clientY - button.offsetTop - radius}px`;
                ripple.classList.add('ripple-effect');

                const existingRipple = button.getElementsByClassName('ripple-effect')[0];
                if (existingRipple) {
                    existingRipple.remove();
                }

                button.appendChild(ripple);
            }

            document.addEventListener('DOMContentLoaded', () => {
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(button => {
                    button.addEventListener('click', createRipple);
                });

                // Add ripple effect styles dynamically
                const style = document.createElement('style');
                style.textContent = `
                .btn {
                    position: relative;
                    overflow: hidden;
                }
                .ripple-effect {
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.6);
                    transform: scale(0);
                    animation: ripple-animation 0.6s ease-out;
                    pointer-events: none;
                }
                @keyframes ripple-animation {
                    to {
                        transform: scale(4);
                        opacity: 0;
                    }
                }
            `;
                document.head.appendChild(style);
            });

            // ========================================
            // NOTIFICATION SYSTEM
            // ========================================

            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 16px 24px;
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                color: var(--text-primary);
                font-weight: 500;
                z-index: 10000;
                animation: slideInRight 0.5s ease;
                box-shadow: 0 8px 32px var(--shadow-color);
            `;

                const icon = type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ';
                notification.innerHTML = `<span style="margin-right: 10px;">${icon}</span>${message}`;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            }

            // Add animation keyframes for notifications
            const notifStyle = document.createElement('style');
            notifStyle.textContent = `
            @keyframes fadeOut {
                to { opacity: 0; transform: translateX(100px); }
            }
        `;
            document.head.appendChild(notifStyle);

            // ========================================
            // KEYBOARD NAVIGATION ENHANCEMENTS
            // ========================================

            document.addEventListener('keydown', (e) => {
                // Escape to close modals (if any)
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal, .overlay');
                    modals.forEach(modal => modal.style.display = 'none');
                }
            });

            // ========================================
            // ACCESSIBILITY ENHANCEMENTS
            // ========================================

            document.addEventListener('DOMContentLoaded', () => {
                // Add skip to main content link
                const skipLink = document.createElement('a');
                skipLink.href = '#main-content';
                skipLink.className = 'skip-link';
                skipLink.textContent = 'Skip to main content';
                skipLink.style.cssText = `
                position: absolute;
                top: -40px;
                left: 0;
                background: var(--accent-color);
                color: white;
                padding: 8px 16px;
                text-decoration: none;
                border-radius: 0 0 8px 0;
                z-index: 100;
            `;
                skipLink.addEventListener('focus', () => {
                    skipLink.style.top = '0';
                });
                skipLink.addEventListener('blur', () => {
                    skipLink.style.top = '-40px';
                });
                document.body.insertBefore(skipLink, document.body.firstChild);

                // Add main content ID if it doesn't exist
                const mainContent = document.querySelector('.dashboard-content');
                if (mainContent && !mainContent.id) {
                    mainContent.id = 'main-content';
                }
            });

            console.log('🎨 Guide Dashboard Loaded Successfully - No Stretching Effects!');


            let questionCount = 0;

            function addQuestion() {
                questionCount++;
                const container = document.getElementById('questions-container');
                const questionBlock = document.createElement('div');
                questionBlock.className = 'question-block';
                questionBlock.id = `question-${questionCount}`;

                questionBlock.innerHTML = `
                <div class="question-header">
                    <h4>Question ${questionCount}</h4>
                    <button type="button" class="remove-question-btn" onclick="removeQuestion(${questionCount})">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="form-group">
                    <label>Question Text *</label>
                    <textarea name="question_text[]" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Marks *</label>
                    <input type="number" name="question_marks[]" min="1" step="0.5" required onchange="updateTotalMarks()">
                </div>
            `;

                container.appendChild(questionBlock);
            }

            function removeQuestion(id) {
                const block = document.getElementById(`question-${id}`);
                if (block) {
                    block.remove();
                    updateTotalMarks();
                }
            }

            function updateTotalMarks() {
                const marksInputs = document.querySelectorAll('input[name="question_marks[]"]');
                let total = 0;
                marksInputs.forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                document.getElementById('total-marks').textContent = total.toFixed(1);
            }

            // Add first question by default
            document.addEventListener('DOMContentLoaded', () => {
                addQuestion();
                loadAssignmentsForScores();
            });

            // Quick deadline setter
            function setDeadlineQuick(option) {
                const deadlineInput = document.getElementById('assignment_deadline');
                const now = new Date();
                let deadline = new Date();

                switch (option) {
                    case '1h':
                        deadline.setHours(now.getHours() + 1);
                        break;
                    case '3h':
                        deadline.setHours(now.getHours() + 3);
                        break;
                    case '6h':
                        deadline.setHours(now.getHours() + 6);
                        break;
                    case '12h':
                        deadline.setHours(now.getHours() + 12);
                        break;
                    case 'tomorrow':
                        deadline.setDate(now.getDate() + 1);
                        deadline.setHours(23, 59, 0, 0);
                        break;
                    case '2d':
                        deadline.setDate(now.getDate() + 2);
                        deadline.setHours(23, 59, 0, 0);
                        break;
                    case '3d':
                        deadline.setDate(now.getDate() + 3);
                        deadline.setHours(23, 59, 0, 0);
                        break;
                    case '7d':
                        deadline.setDate(now.getDate() + 7);
                        deadline.setHours(23, 59, 0, 0);
                        break;
                }

                // Format for datetime-local input (YYYY-MM-DDTHH:mm)
                const year = deadline.getFullYear();
                const month = String(deadline.getMonth() + 1).padStart(2, '0');
                const day = String(deadline.getDate()).padStart(2, '0');
                const hours = String(deadline.getHours()).padStart(2, '0');
                const minutes = String(deadline.getMinutes()).padStart(2, '0');

                deadlineInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // Handle assignment form submission with comprehensive error handling
            document.addEventListener('DOMContentLoaded', function () {
                const assignmentForm = document.getElementById('assignmentForm');
                if (!assignmentForm) return;

                assignmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Clear previous alerts
                    const alertContainer = document.getElementById('assignment-alert');
                    alertContainer.innerHTML = '';

                    // Get form elements
                    const courseSelect = document.getElementById('assignment_course');
                    const nameInput = document.getElementById('assignment_name');
                    const deadlineInput = document.getElementById('assignment_deadline');
                    const submitBtn = assignmentForm.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.innerHTML;

                    // Client-side validation
                    if (!courseSelect.value) {
                        showAssignmentAlert('Please select a course', 'error');
                        courseSelect.focus();
                        courseSelect.style.borderColor = '#dc3545';
                        return;
                    } else {
                        courseSelect.style.borderColor = '';
                    }

                    if (!nameInput.value.trim()) {
                        showAssignmentAlert('Please enter an assignment name', 'error');
                        nameInput.focus();
                        nameInput.style.borderColor = '#dc3545';
                        return;
                    } else {
                        nameInput.style.borderColor = '';
                    }

                    if (nameInput.value.trim().length < 3) {
                        showAssignmentAlert('Assignment name must be at least 3 characters long', 'error');
                        nameInput.focus();
                        nameInput.style.borderColor = '#dc3545';
                        return;
                    }

                    if (!deadlineInput.value) {
                        showAssignmentAlert('Please select a deadline', 'error');
                        deadlineInput.focus();
                        deadlineInput.style.borderColor = '#dc3545';
                        return;
                    } else {
                        deadlineInput.style.borderColor = '';
                    }

                    // Check if deadline is in the past
                    const deadlineDate = new Date(deadlineInput.value);
                    if (deadlineDate <= new Date()) {
                        showAssignmentAlert('Deadline must be in the future', 'error');
                        deadlineInput.focus();
                        deadlineInput.style.borderColor = '#dc3545';
                        return;
                    }

                    // Check if at least one question exists
                    const questionTexts = document.querySelectorAll('textarea[name="question_text[]"]');
                    if (questionTexts.length === 0) {
                        showAssignmentAlert('Please add at least one question', 'error');
                        return;
                    }

                    // Validate all questions
                    let hasEmptyQuestion = false;
                    questionTexts.forEach((textarea, index) => {
                        if (!textarea.value.trim()) {
                            hasEmptyQuestion = true;
                            textarea.style.borderColor = '#dc3545';
                        } else {
                            textarea.style.borderColor = '';
                        }
                    });

                    if (hasEmptyQuestion) {
                        showAssignmentAlert('Please fill in all question texts', 'error');
                        return;
                    }

                    // Validate marks
                    const marksInputs = document.querySelectorAll('input[name="question_marks[]"]');
                    let hasInvalidMarks = false;
                    marksInputs.forEach((input, index) => {
                        const marks = parseFloat(input.value);
                        if (!marks || marks <= 0) {
                            hasInvalidMarks = true;
                            input.style.borderColor = '#dc3545';
                        } else {
                            input.style.borderColor = '';
                        }
                    });

                    if (hasInvalidMarks) {
                        showAssignmentAlert('Please enter valid marks (greater than 0) for all questions', 'error');
                        return;
                    }

                    // Prepare form data
                    const formData = new FormData(assignmentForm);

                    // Disable button and show loading
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Assignment...';

                    try {
                        const response = await fetch('/guide/assignments/create', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': '{{ csrf_token() }}'
                            }
                        });

                        const data = await response.json();

                        if (data.success) {
                            showAssignmentAlert('✅ ' + data.message, 'success');

                            // Reset form
                            assignmentForm.reset();

                            // Restore default instructions
                            const instructionsTextarea = document.getElementById('assignment_instructions');
                            if (instructionsTextarea) {
                                instructionsTextarea.value = 'Please complete this assignment with the following guidelines:\n- Write clearly and legibly\n- Show all your work and calculations\n- Answer all questions completely\n- Follow the format specified for each question\n- Submit before the deadline\n\nYou can edit or remove this default text as needed.';
                            }

                            // Reset questions
                            questionCount = 0;
                            document.getElementById('questions-container').innerHTML = '';
                            addQuestion();

                            // Reload assignments list
                            loadAssignmentsForScores();

                            // Switch to View Assignments tab after a short delay
                            setTimeout(() => {
                                // Remove active class from all tabs and content
                                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                                // Activate View Assignments tab
                                const viewAssignmentsTab = document.querySelector('a[href="#view-assignments"]');
                                const viewAssignmentsContent = document.getElementById('view-assignments');

                                if (viewAssignmentsTab && viewAssignmentsContent) {
                                    viewAssignmentsTab.classList.add('active');
                                    viewAssignmentsContent.classList.add('active');

                                    // Load assignments list
                                    loadAssignments();

                                    // Scroll to top smoothly
                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                }
                            }, 500);
                        } else {
                            showAssignmentAlert('❌ ' + (data.message || 'Failed to create assignment'), 'error');

                            // Highlight error fields if specified
                            if (data.field) {
                                const fieldMap = {
                                    'course_id': courseSelect,
                                    'name': nameInput,
                                    'deadline': deadlineInput
                                };
                                const errorField = fieldMap[data.field];
                                if (errorField) {
                                    errorField.style.borderColor = '#dc3545';
                                    errorField.focus();
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error creating assignment:', error);
                        showAssignmentAlert('❌ Network error: Could not connect to server. Please check your connection and try again.', 'error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    }
                });
            });

            function showAssignmentAlert(message, type) {
                const container = document.getElementById('assignment-alert');
                container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => container.innerHTML = '', 5000);
            }

            // Load assignments when switching to view tab
            document.querySelector('a[href="#view-assignments"]').addEventListener('click', loadAssignments);

            async function loadAssignments() {
                try {
                    const response = await fetch('/guide/assignments/list');
                    const data = await response.json();

                    if (data.success) {
                        displayAssignments(data.assignments);
                    }
                } catch (error) {
                    console.error('Error loading assignments:', error);
                }
            }

            function displayAssignments(assignments) {
                const container = document.getElementById('assignments-list');

                if (assignments.length === 0) {
                    container.innerHTML = '<div class="card glass"><p>No assignments created yet.</p></div>';
                    return;
                }

                container.innerHTML = assignments.map(assignment => `
                <div class="card glass-strong" style="margin-bottom: 20px;">
                    <h3>${assignment.name}</h3>
                    <p><strong>Course:</strong> ${assignment.course_name}</p>
                    <p><strong>Deadline:</strong> ${assignment.deadline}</p>
                    <p><strong>Total Marks:</strong> ${assignment.total_marks}</p>
                    <p><strong>Model:</strong> ${assignment.evaluation_model}</p>
                    <p><strong>Submissions:</strong> ${assignment.submissions_count} learners</p>
                    <button class="btn btn-primary" onclick="viewSubmissions(${assignment.id})">
                        <i class="fas fa-eye"></i> View Submissions
                    </button>
                </div>
            `).join('');
            }

            async function viewSubmissions(assignmentId) {
                try {
                    const response = await fetch(`/guide/assignments/${assignmentId}/submissions`);
                    const data = await response.json();

                    if (data.success) {
                        displaySubmissions(data.submissions, data.assignment);
                    }
                } catch (error) {
                    console.error('Error loading submissions:', error);
                }
            }

            function displaySubmissions(submissions, assignment) {
                const container = document.getElementById('assignments-list');

                if (submissions.length === 0) {
                    container.innerHTML = `
                    <button class="btn" onclick="loadAssignments()">← Back to Assignments</button>
                    <div class="card glass"><p>No submissions yet for this assignment.</p></div>
                `;
                    return;
                }

                container.innerHTML = `
                <button class="btn" onclick="loadAssignments()" style="margin-bottom: 20px;">← Back to Assignments</button>
                <h2>${assignment.name} - Submissions</h2>
                ${submissions.map(sub => `
                <div class="submission-card" data-submission-id="${sub.submission_id}">
                        <div class="submission-header">
                            <div>
                                <h3>${sub.learner_name}</h3>
                                <p style="color: var(--text-secondary);">Submitted: ${sub.submitted_at}</p>
                            <p><strong>Total Score: <span id="submission-total-score-value-${sub.submission_id}" data-current-total="${sub.total_score}">${sub.total_score}</span> / ${assignment.total_marks}</strong></p>
                                
                                <!-- MCQ SUMMARY -->
                                ${sub.mcq_summary ? `
                                    <p style="margin-top: 10px;">
                                        <span class="badge" style="background: ${sub.mcq_summary.all_correct ? 'var(--success)' : 'var(--error)'};">
                                            MCQ: ${sub.mcq_summary.correct}/${sub.mcq_summary.total} correct
                                        </span>
                                    </p>
                                ` : ''}
                            </div>
                            ${sub.is_flagged ? `<span class="flag-badge"><i class="fas fa-flag"></i> ${sub.flag_reason}</span>` : ''}
                        </div>
                        
                        ${sub.answers.map((answer, idx) => `
                            <div class="answer-section">
                                <h4>Question ${idx + 1}: ${answer.question_text}</h4>
                                
                                <div class="answer-images">
                                    ${answer.images.map(img => `
                                        <img src="/${img}" alt="Answer" class="answer-image" onclick="window.open('/${img}', '_blank')">
                                    `).join('')}
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <strong>Extracted Text:</strong>
                                    <p style="background: var(--hover-bg); padding: 15px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap;">${answer.extracted_text || 'No text extracted'}</p>
                                </div>
                                
                                <div class="score-breakdown">
                                    <div class="score-item">
                                        <div class="score-value">${answer.relevance_score}</div>
                                        <div class="score-label">Relevance (50%)</div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-value">${answer.grammar_score}</div>
                                        <div class="score-label">Grammar (10%)</div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-value">${answer.size_score}</div>
                                        <div class="score-label">Size (30%)</div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-value">${answer.uniqueness_score}</div>
                                        <div class="score-label">Uniqueness (10%)</div>
                                    </div>
                                    <div class="score-item" style="grid-column: span 2;">
                                        <div
                                            class="score-value"
                                            id="answer-score-display-${answer.answer_id}"
                                            data-max-marks="${answer.max_marks}"
                                        >${answer.total_score} / ${answer.max_marks}</div>
                                        <div class="score-label">Total Score</div>
                                    </div>
                                </div>
                                <div class="score-edit" style="margin-top: 15px;">
                                    <div style="display:flex; align-items:center; gap: 10px;">
                                        <label for="score-input-${answer.answer_id}" style="font-weight:600; color:#111827;">Final Mark</label>
                                        <input
                                            type="number"
                                            step="0.5"
                                            min="0"
                                            max="${answer.max_marks}"
                                            id="score-input-${answer.answer_id}"
                                            data-current-score="${answer.total_score}"
                                            value="${(typeof answer.total_score === 'number' ? answer.total_score : 0).toFixed(1)}"
                                            style="width:120px; padding:6px 10px; border-radius:8px; border:1px solid #d1d5db; background:#fff;"
                                        >
                                        <button type="button" class="btn btn-primary" onclick="updateAnswerScore(${answer.answer_id}, ${sub.submission_id})" style="padding:6px 16px; font-size:0.85rem; line-height:1;">Save</button>
                                        <span id="score-status-${answer.answer_id}" style="font-size:0.85rem; color:#10b981;"></span>
                                    </div>
                                    <small style="color:#6b7280; display:block; margin-top:4px;">Max ${answer.max_marks} marks</small>
                                </div>
                                
                                <div class="feedback-section">
                                    <strong><i class="fas fa-comment"></i> AI Feedback:</strong>
                                    <p>${answer.feedback}</p>
                                    
                                    ${answer.covered_points.length > 0 ? `
                                        <strong style="display: block; margin-top: 15px;">Covered Points:</strong>
                                        <ul class="points-list">
                                            ${answer.covered_points.map(point => `<li class="covered-point">${point}</li>`).join('')}
                                        </ul>
                                    ` : ''}
                                    
                                    ${answer.missing_points.length > 0 ? `
                                        <strong style="display: block; margin-top: 15px;">Missing Points:</strong>
                                        <ul class="points-list">
                                            ${answer.missing_points.map(point => `<li class="missing-point">${point}</li>`).join('')}
                                        </ul>
                                    ` : ''}
                                    
                                    <p style="margin-top: 10px;"><small>Word Count: ${answer.word_count} words</small></p>
                                </div>

                                ${answer.mcq_result ? `
                                    <div style="margin-top: 15px; padding: 15px; background: ${answer.mcq_result.is_correct ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 8px;">
                                        <strong><i class="fas fa-question-circle"></i> MCQ Verification:</strong>
                                        <p style="margin-top: 8px;">
                                            Type: ${answer.mcq_result.type === 'question' ? 'Question Understanding' : 'Answer Understanding'}<br>
                                            Result: ${answer.mcq_result.is_correct ? '✅ Correct' : '❌ Incorrect'}<br>
                                            Time: ${answer.mcq_result.time_taken}s<br>
                                            ${!answer.mcq_result.is_correct ? `Answer: ${answer.mcq_result.learner_answer} (Correct: ${answer.mcq_result.correct_answer})` : ''}
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
            `;
            }

            // Scores page functionality
            async function loadAssignmentsForScores() {
                try {
                    const response = await fetch('/guide/assignments/list');
                    const data = await response.json();

                    if (data.success) {
                        const select = document.getElementById('scores_assignment');
                        select.innerHTML = '<option value="">Choose assignment...</option>' +
                            data.assignments.map(a => `<option value="${a.id}">${a.name} - ${a.course_name}</option>`).join('');
                    }
                } catch (error) {
                    console.error('Error loading assignments:', error);
                }
            }

            document.getElementById('scores_assignment').addEventListener('change', async (e) => {
                const assignmentId = e.target.value;
                if (!assignmentId) {
                    document.getElementById('scores-container').innerHTML = '';
                    return;
                }

                await loadScores(assignmentId);
            });

            async function loadScores(assignmentId) {
                try {
                    const response = await fetch(`/guide/assignments/${assignmentId}/scores`);
                    const data = await response.json();

                    if (data.success) {
                        displayScores(data.scores, data.assignment);
                    }
                } catch (error) {
                    console.error('Error loading scores:', error);
                }
            }

            function displayScores(scores, assignment) {
                const container = document.getElementById('scores-container');

                if (scores.length === 0) {
                    container.innerHTML = '<p>No submissions yet.</p>';
                    return;
                }

                container.innerHTML = `
                <div class="visibility-toggle">
                    <button class="btn ${assignment.scores_visible ? 'btn-primary' : ''}" onclick="toggleScoresVisibility(${assignment.id}, ${!assignment.scores_visible})">
                        <i class="fas fa-eye${assignment.scores_visible ? '-slash' : ''}"></i>
                        ${assignment.scores_visible ? 'Hide' : 'Show'} Scores to Learners
                    </button>
                </div>
                
                <div class="download-buttons">
                    <button class="btn btn-primary" onclick="downloadAllReportsPDF(${assignment.id})">
                        <i class="fas fa-file-pdf"></i> Download All Reports (PDF)
                    </button>
                    <button class="btn" onclick="downloadScoresCSV(${assignment.id})">
                        <i class="fas fa-file-csv"></i> Download Scores (CSV)
                    </button>
                </div>
                
                <table class="scores-table">
                    <thead>
                        <tr>
                            <th>Learner</th>
                            <th>Submitted</th>
                            <th>Total Score</th>
                            <th>Percentage</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scores.map(score => `
                            <tr>
                                <td>${score.learner_name}</td>
                                <td>${score.submitted_at}</td>
                                <td><strong>${score.total_score} / ${assignment.total_marks}</strong></td>
                                <td>${score.percentage}%</td>
                                <td>
                                    ${score.is_flagged ? '<span class="flag-badge">Flagged</span>' : '<span class="badge" style="background: var(--success);">Clean</span>'}
                                </td>
                                <td>
                                    <button class="btn" onclick="downloadIndividualReport(${score.submission_id})">
                                        <i class="fas fa-download"></i> PDF
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            }

            async function toggleScoresVisibility(assignmentId, visible) {
                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    const headers = { 'Content-Type': 'application/json' };
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const response = await fetch(`/guide/assignments/${assignmentId}/visibility`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ visible })
                    });

                    const data = await response.json();
                    if (data.success) {
                        loadScores(assignmentId);
                    }
                } catch (error) {
                    console.error('Error toggling visibility:', error);
                }
            }

            async function downloadIndividualReport(submissionId) {
                window.open(`/guide/assignments/submission/${submissionId}/report`, '_blank');
            }

            async function downloadAllReportsPDF(assignmentId) {
                window.open(`/guide/assignments/${assignmentId}/reports/pdf`, '_blank');
            }

            async function downloadScoresCSV(assignmentId) {
                window.open(`/guide/assignments/${assignmentId}/scores/csv`, '_blank');
            }




            // Load assignments for MCQ tab
            document.addEventListener('DOMContentLoaded', () => {
                loadAssignmentsForMCQ();
            });

            async function loadAssignmentsForMCQ() {
                try {
                    const response = await fetch('/guide/assignments/list');
                    const data = await response.json();

                    if (data.success) {
                        const select = document.getElementById('mcq_assignment');
                        select.innerHTML = '<option value="">Choose assignment...</option>' +
                            data.assignments.map(a => `<option value="${a.id}">${a.name} - ${a.course_name}</option>`).join('');
                    }
                } catch (error) {
                    console.error('Error loading assignments:', error);
                }
            }

            document.getElementById('mcq_assignment').addEventListener('change', async (e) => {
                const assignmentId = e.target.value;
                if (!assignmentId) {
                    document.getElementById('mcq-results-container').innerHTML = '';
                    return;
                }

                await loadMCQResults(assignmentId);
            });

            async function loadMCQResults(assignmentId) {
                try {
                    const response = await fetch(`/guide/assignments/${assignmentId}/mcq-results`);
                    const data = await response.json();

                    if (data.success) {
                        displayMCQResults(data.results, data.assignment);
                    }
                } catch (error) {
                    console.error('Error loading MCQ results:', error);
                }
            }

            function displayMCQResults(results, assignment) {
                const container = document.getElementById('mcq-results-container');

                if (results.length === 0) {
                    container.innerHTML = '<p>No MCQ responses yet.</p>';
                    return;
                }

                // Calculate statistics
                const totalResponses = results.reduce((sum, r) => sum + r.answers.length, 0);
                const correctResponses = results.reduce((sum, r) =>
                    sum + r.answers.filter(a => a.mcq_result && a.mcq_result.is_correct).length, 0);
                const accuracy = totalResponses > 0 ? ((correctResponses / totalResponses) * 100).toFixed(1) : 0;

                container.innerHTML = `
        <!-- Overall Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                <i class="fas fa-users" style="font-size: 2rem; color: var(--accent-color); margin-bottom: 10px;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">${results.length}</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Learners</div>
            </div>
            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                <i class="fas fa-question-circle" style="font-size: 2rem; color: var(--accent-color); margin-bottom: 10px;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">${totalResponses}</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Total MCQs</div>
            </div>
            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${correctResponses}</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Correct Answers</div>
            </div>
            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                <i class="fas fa-percentage" style="font-size: 2rem; color: ${accuracy >= 70 ? 'var(--success)' : 'var(--error)'}; margin-bottom: 10px;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: ${accuracy >= 70 ? 'var(--success)' : 'var(--error)'};">${accuracy}%</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Overall Accuracy</div>
            </div>
        </div>

        <!-- Download Options -->
        <div style="display: flex; gap: 15px; margin-bottom: 30px;">
            <button class="btn btn-primary" onclick="downloadMCQReport(${assignment.id})">
                <i class="fas fa-file-pdf"></i> Download PDF Report
            </button>
            <button class="btn" onclick="downloadMCQCSV(${assignment.id})">
                <i class="fas fa-file-csv"></i> Download CSV
            </button>
        </div>

        <!-- Detailed Results Table -->
        <h3 style="margin-top: 30px; margin-bottom: 20px;">Detailed MCQ Results</h3>
        <table class="scores-table">
            <thead>
                <tr>
                    <th>Learner</th>
                    <th>Question</th>
                    <th>MCQ Type</th>
                    <th>Result</th>
                    <th>Time Taken</th>
                    <th>Answer Given</th>
                    <th>Correct Answer</th>
                </tr>
            </thead>
            <tbody>
                ${results.map(learner =>
                    learner.answers.map((answer, idx) => {
                        const mcq = answer.mcq_result;
                        if (!mcq) return '';

                        return `
                            <tr style="background: ${mcq.is_correct ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)'};">
                                ${idx === 0 ? `
                                    <td rowspan="${learner.answers.filter(a => a.mcq_result).length}">
                                        <strong>${learner.learner_name}</strong>
                                    </td>
                                ` : ''}
                                <td>Question ${answer.question_number}</td>
                                <td>
                                    <span class="badge" style="background: ${mcq.type === 'question' ? 'var(--accent-color)' : '#8b5cf6'};">
                                        ${mcq.type === 'question' ? 'Question Topic' : 'Answer Understanding'}
                                    </span>
                                </td>
                                <td>
                                    ${mcq.is_correct
                                ? '<span style="color: var(--success); font-weight: 600;">✅ Correct</span>'
                                : '<span style="color: var(--error); font-weight: 600;">❌ Wrong</span>'
                            }
                                </td>
                                <td>${mcq.time_taken}s</td>
                                <td>
                                    <strong style="color: ${mcq.is_correct ? 'var(--success)' : 'var(--error)'};">
                                        ${mcq.learner_answer || 'No answer'}
                                    </strong>
                                </td>
                                <td>
                                    <strong style="color: var(--success);">
                                        ${mcq.correct_answer}
                                    </strong>
                                </td>
                            </tr>
                        `;
                    }).join('')
                ).join('')}
            </tbody>
        </table>

        <!-- Learner-wise Summary -->
        <h3 style="margin-top: 40px; margin-bottom: 20px;">Learner-wise MCQ Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            ${results.map(learner => {
                    const mcqAnswers = learner.answers.filter(a => a.mcq_result);
                    const correct = mcqAnswers.filter(a => a.mcq_result.is_correct).length;
                    const total = mcqAnswers.length;
                    const percentage = total > 0 ? ((correct / total) * 100).toFixed(0) : 0;

                    return `
                    <div class="card glass" style="padding: 20px;">
                        <h4 style="margin-bottom: 15px;">${learner.learner_name}</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>MCQ Score:</span>
                            <strong style="font-size: 1.2rem; color: ${percentage >= 70 ? 'var(--success)' : percentage >= 50 ? 'var(--warning)' : 'var(--error)'};">
                                ${correct}/${total}
                            </strong>
                        </div>
                        <div class="progress-bar" style="height: 10px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden;">
                            <div class="progress-fill" style="width: ${percentage}%; height: 100%; background: ${percentage >= 70 ? 'var(--success)' : percentage >= 50 ? 'var(--warning)' : 'var(--error)'}; transition: width 1s ease;"></div>
                        </div>
                        <p style="text-align: center; margin-top: 10px; font-size: 1.5rem; font-weight: 700; color: ${percentage >= 70 ? 'var(--success)' : percentage >= 50 ? 'var(--warning)' : 'var(--error)'};">
                            ${percentage}%
                        </p>
                        ${percentage < 50 ? '<p style="color: var(--error); font-size: 0.85rem; margin-top: 10px; text-align: center;">⚠️ Needs Attention</p>' : ''}
                    </div>
                `;
                }).join('')}
        </div>
    `;
            }

            async function downloadMCQReport(assignmentId) {
                window.open(`/guide/assignments/${assignmentId}/mcq-report/pdf`, '_blank');
            }

            async function downloadMCQCSV(assignmentId) {
                window.open(`/guide/assignments/${assignmentId}/mcq-report/csv`, '_blank');
            }

            async function updateAnswerScore(answerId, submissionId) {
                const input = document.getElementById(`score-input-${answerId}`);
                const status = document.getElementById(`score-status-${answerId}`);
                if (!input || !status) return;

                const value = parseFloat(input.value);
                const max = parseFloat(input.getAttribute('max'));
                const previousScore = parseFloat(input.dataset.currentScore || '0');

                status.textContent = '';
                status.style.color = '#10b981';

                if (Number.isNaN(value)) {
                    status.textContent = 'Enter a number';
                    status.style.color = '#ef4444';
                    return;
                }
                if (value < 0) {
                    status.textContent = 'Score must be ≥ 0';
                    status.style.color = '#ef4444';
                    return;
                }
                if (!Number.isNaN(max) && value > max) {
                    status.textContent = `Max ${max}`;
                    status.style.color = '#ef4444';
                    return;
                }

                status.textContent = 'Saving...';

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const response = await fetch(`/guide/assignments/answers/${answerId}/score`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ total_score: value })
                    });

                    const data = await response.json();
                    if (data.success) {
                        const newScore = Number(data.total_score);
                        status.textContent = 'Saved';
                        status.style.color = '#10b981';
                        input.value = newScore.toFixed(1);
                        input.dataset.currentScore = newScore;

                        const display = document.getElementById(`answer-score-display-${answerId}`);
                        if (display) {
                            const maxMarks = display.dataset.maxMarks;
                            display.textContent = maxMarks
                                ? `${newScore.toFixed(1)} / ${maxMarks}`
                                : `${newScore.toFixed(1)}`;
                        }

                        const submissionTotal = document.getElementById(`submission-total-score-value-${submissionId}`);
                        if (submissionTotal) {
                            const currentTotal = parseFloat(submissionTotal.dataset.currentTotal || submissionTotal.textContent) || 0;
                            const delta = newScore - previousScore;
                            const updatedTotal = currentTotal + delta;
                            submissionTotal.textContent = updatedTotal.toFixed(1);
                            submissionTotal.dataset.currentTotal = updatedTotal;
                        }

                        setTimeout(() => { status.textContent = ''; }, 2000);
                    } else {
                        status.textContent = data.error || 'Save failed';
                        status.style.color = '#ef4444';
                    }
                } catch (error) {
                    status.textContent = 'Error saving';
                    status.style.color = '#ef4444';
                }
            }

            // Plagiarism Accuracy Functions
            document.addEventListener('DOMContentLoaded', () => {
                loadAssignmentsForPlagiarismAccuracy();
            });

            async function loadAssignmentsForPlagiarismAccuracy() {
                try {
                    const response = await fetch('/guide/assignments/list');
                    const data = await response.json();

                    if (data.success) {
                        const select = document.getElementById('plagiarism_accuracy_assignment');
                        select.innerHTML = '<option value="">Choose assignment...</option>' +
                            data.assignments.map(a => `<option value="${a.id}">${a.name} - ${a.course_name}</option>`).join('');
                    }
                } catch (error) {
                    console.error('Error loading assignments:', error);
                }
            }

            document.getElementById('plagiarism_accuracy_assignment').addEventListener('change', async (e) => {
                const assignmentId = e.target.value;
                if (!assignmentId) {
                    document.getElementById('plagiarism-accuracy-container').innerHTML = '';
                    return;
                }

                await loadPlagiarismAccuracy(assignmentId);
            });

            async function loadPlagiarismAccuracy(assignmentId) {
                try {
                    const response = await fetch(`/guide/assignments/${assignmentId}/plagiarism-accuracy`);
                    const data = await response.json();

                    if (data.success) {
                        displayPlagiarismAccuracy(data.results, data.assignment);
                    } else {
                        document.getElementById('plagiarism-accuracy-container').innerHTML =
                            `<p style="color: var(--error);">${data.message || 'Error loading plagiarism accuracy'}</p>`;
                    }
                } catch (error) {
                    console.error('Error loading plagiarism accuracy:', error);
                    document.getElementById('plagiarism-accuracy-container').innerHTML =
                        '<p style="color: var(--error);">Error loading plagiarism accuracy results</p>';
                }
            }

            function displayPlagiarismAccuracy(results, assignment) {
                const container = document.getElementById('plagiarism-accuracy-container');

                if (results.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">No plagiarism accuracy data available yet.</p>';
                    return;
                }

                // Calculate statistics
                const totalAnswers = results.reduce((sum, r) => sum + r.answers.length, 0);
                const avgPlagiarism = results.reduce((sum, r) =>
                    sum + r.answers.reduce((s, a) => s + a.plagiarism_score, 0), 0) / totalAnswers;
                const avgAI = results.reduce((sum, r) =>
                    sum + r.answers.reduce((s, a) => s + a.ai_confidence, 0), 0) / totalAnswers;
                const highRiskCount = results.reduce((sum, r) =>
                    sum + r.answers.filter(a => a.plagiarism_score >= 50 || a.ai_confidence >= 50).length, 0);

                container.innerHTML = `
                    <!-- Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                        <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                            <i class="fas fa-users" style="font-size: 2rem; color: var(--accent-color); margin-bottom: 10px;"></i>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">${results.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Learners Analyzed</div>
                        </div>
                        <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                            <i class="fas fa-percentage" style="font-size: 2rem; color: ${avgPlagiarism >= 50 ? 'var(--error)' : 'var(--success)'}; margin-bottom: 10px;"></i>
                            <div style="font-size: 2rem; font-weight: 700; color: ${avgPlagiarism >= 50 ? 'var(--error)' : 'var(--success)'};">${avgPlagiarism.toFixed(1)}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Avg Plagiarism</div>
                        </div>
                        <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                            <i class="fas fa-robot" style="font-size: 2rem; color: ${avgAI >= 50 ? 'var(--error)' : 'var(--success)'}; margin-bottom: 10px;"></i>
                            <div style="font-size: 2rem; font-weight: 700; color: ${avgAI >= 50 ? 'var(--error)' : 'var(--success)'};">${avgAI.toFixed(1)}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Avg AI Confidence</div>
                        </div>
                        <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--error); margin-bottom: 10px;"></i>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--error);">${highRiskCount}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">High Risk Answers</div>
                        </div>
                    </div>

                    <!-- Detailed Results -->
                    <h3 style="margin-top: 30px; margin-bottom: 20px;">Detailed Analysis</h3>
                    ${results.map(learner => `
                        <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">
                                <i class="fas fa-user"></i> ${learner.learner_name}
                            </h4>
                            ${learner.answers.map(answer => {
                    const plagColor = answer.plagiarism_score >= 70 ? 'var(--error)' :
                        answer.plagiarism_score >= 50 ? '#f59e0b' : 'var(--success)';
                    const aiColor = answer.ai_confidence >= 70 ? 'var(--error)' :
                        answer.ai_confidence >= 50 ? '#f59e0b' : 'var(--success)';

                    return `
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${plagColor};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                            <div>
                                                <strong>Question ${answer.question_number}:</strong> ${answer.question_text.substring(0, 100)}${answer.question_text.length > 100 ? '...' : ''}
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                                            <div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Plagiarism Score</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: ${plagColor};">
                                                    ${answer.plagiarism_score.toFixed(1)}%
                                                </div>
                                                ${answer.plagiarism_detected ? '<span style="color: var(--error); font-size: 0.8rem;">⚠️ Detected</span>' : ''}
                                            </div>
                                            <div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">AI Confidence</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: ${aiColor};">
                                                    ${answer.ai_confidence.toFixed(1)}%
                                                </div>
                                                ${answer.ai_detected ? '<span style="color: var(--error); font-size: 0.8rem;">⚠️ Detected</span>' : ''}
                                            </div>
                                        </div>
                                        ${answer.matches && answer.matches.length > 0 ? `
                                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Detected Indicators:</div>
                                                ${answer.matches.slice(0, 3).map(m => `
                                                    <div style="font-size: 0.8rem; color: var(--text-primary); margin-bottom: 5px;">
                                                        • ${m.text || m.status || 'Indicator'} - ${m.confidence || 'Medium'} confidence
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                        ${answer.extracted_text ? `
                                            <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.85rem; color: var(--text-secondary);">
                                                <strong>Extracted Text:</strong> ${answer.extracted_text}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                }).join('')}
                        </div>
                    `).join('')}
                `;
            }

            // Load assignments for plagiarism tab
            document.addEventListener('DOMContentLoaded', () => {
                loadAssignmentsForPlagiarism();
            });

            async function loadAssignmentsForPlagiarism() {
                try {
                    const response = await fetch('/guide/assignments/list');
                    const data = await response.json();

                    if (data.success) {
                        const select = document.getElementById('plagiarism_assignment');
                        select.innerHTML = '<option value="">Choose assignment...</option>' +
                            data.assignments.map(a => `<option value="${a.id}">${a.name} - ${a.course_name}</option>`).join('');
                    }
                } catch (error) {
                    console.error('Error loading assignments:', error);
                }
            }

            document.getElementById('plagiarism_assignment').addEventListener('change', async (e) => {
                const assignmentId = e.target.value;
                if (!assignmentId) {
                    document.getElementById('plagiarism-results-container').innerHTML = '';
                    return;
                }

                await loadPlagiarismResults(assignmentId);
            });

            async function loadPlagiarismResults(assignmentId) {
                try {
                    const response = await fetch(`/guide/assignments/${assignmentId}/plagiarism`);
                    const data = await response.json();

                    if (data.success) {
                        displayPlagiarismResults(data.results, data.assignment);
                    }
                } catch (error) {
                    console.error('Error loading plagiarism results:', error);
                }
            }

            function displayPlagiarismResults(results, assignment) {
                const container = document.getElementById('plagiarism-results-container');

                if (results.length === 0) {
                    container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--success);">
                <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>No Plagiarism Detected!</h3>
                <p style="color: var(--text-secondary);">All submissions appear to be original work.</p>
            </div>
        `;
                    return;
                }

                // Calculate statistics
                const totalMatches = results.reduce((sum, r) => sum + r.plagiarism_matches.length, 0);
                const pendingMatches = results.reduce((sum, r) =>
                    sum + r.plagiarism_matches.filter(m => m.status === 'pending').length, 0);
                const penalizedMatches = results.reduce((sum, r) =>
                    sum + r.plagiarism_matches.filter(m => m.status === 'penalized').length, 0);

                container.innerHTML = `
        <!-- Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--warning); margin-bottom: 10px;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--warning);">${totalMatches}</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Matches</div>
            </div>
            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                <i class="fas fa-clock" style="font-size: 2rem; color: var(--accent-color); margin-bottom: 10px;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--accent-color);">${pendingMatches}</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Pending Review</div>
            </div>
            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center;">
                <i class="fas fa-gavel" style="font-size: 2rem; color: var(--error); margin-bottom: 10px;"></i>
                <div style="font-size: 2rem; font-weight: 700; color: var(--error);">${penalizedMatches}</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Penalized</div>
            </div>
        </div>

        <!-- Download Options -->
        <div style="display: flex; gap: 15px; margin-bottom: 30px;">
            <button class="btn btn-primary" onclick="downloadPlagiarismReport(${assignment.id})">
                <i class="fas fa-file-pdf"></i> Download PDF Report
            </button>
        </div>

        <!-- Detailed Plagiarism Results -->
        <h3 style="margin-top: 30px; margin-bottom: 20px;">Detailed Plagiarism Matches</h3>
        
        ${results.map(learner => `
            <div class="submission-card" style="margin-bottom: 30px;">
                <div class="submission-header">
                    <div>
                        <h3>${learner.learner_name}</h3>
                        <p style="color: var(--text-secondary);">Total Matches: ${learner.plagiarism_matches.length}</p>
                    </div>
                    ${learner.plagiarism_matches.some(m => m.similarity_score >= 85) ? `
                        <span class="flag-badge"><i class="fas fa-exclamation-triangle"></i> High Similarity</span>
                    ` : ''}
                </div>

                ${learner.plagiarism_matches.map(match => `
                    <div class="plagiarism-match-card" style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; margin: 15px 0; border-left: 4px solid ${match.similarity_score >= 85 ? 'var(--error)' : 'var(--warning)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="color: var(--error); margin-bottom: 5px;">
                                    <i class="fas fa-clone"></i> Match with ${match.matched_learner_name}
                                </h4>
                                <p style="font-size: 1.5rem; font-weight: 700; color: ${match.similarity_score >= 85 ? 'var(--error)' : 'var(--warning)'};">
                                    ${match.similarity_score}% Similarity
                                </p>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">Question ${match.question_number}</p>
                            </div>
                            <span class="badge" style="background: ${match.status === 'pending' ? 'var(--warning)' :
                        match.status === 'ignored' ? 'var(--success)' :
                            'var(--error)'
                    };">
                                ${match.status.toUpperCase()}
                            </span>
                        </div>

                        <!-- Expandable Comparison -->
                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--text-primary); padding: 10px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                                <i class="fas fa-eye"></i> View Text Comparison
                            </summary>
                            <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div style="background: var(--glass-bg); padding: 15px; border-radius: 8px;">
                                    <strong>${learner.learner_name}'s Answer:</strong>
                                    <p style="margin-top: 10px; white-space: pre-wrap; font-size: 0.9rem;">${match.answer_text}</p>
                                </div>
                                <div style="background: var(--glass-bg); padding: 15px; border-radius: 8px;">
                                    <strong>${match.matched_learner_name}'s Answer:</strong>
                                    <p style="margin-top: 10px; white-space: pre-wrap; font-size: 0.9rem;">${match.matched_text}</p>
                                </div>
                            </div>
                        </details>

                        <!-- Actions -->
                        <div style="margin-top: 20px; display: flex; gap: 15px; align-items: center;">
                            ${match.status === 'pending' ? `
                                <div style="display: flex; gap: 10px; align-items: center; flex: 1;">
                                    <label style="font-weight: 600;">Deduct Marks:</label>
                                    <input type="number" id="penalty-${match.match_id}" min="0" max="${match.max_marks}" step="0.5" 
                                           placeholder="0" style="width: 100px; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <button class="btn btn-primary" onclick="applyPenalty(${match.match_id}, ${match.answer_id}, ${match.max_marks})">
                                        <i class="fas fa-gavel"></i> Apply Penalty
                                    </button>
                                </div>
                                <button class="btn" onclick="ignorePlagiarism(${match.match_id})" style="background: var(--success);">
                                    <i class="fas fa-check"></i> Ignore (False Positive)
                                </button>
                            ` : match.status === 'penalized' ? `
                                <div style="color: var(--error); font-weight: 600;">
                                    <i class="fas fa-minus-circle"></i> Penalty Applied: -${match.penalty_marks} marks
                                </div>
                                <button class="btn" onclick="undoPenalty(${match.match_id}, ${match.answer_id})">
                                    <i class="fas fa-undo"></i> Undo Penalty
                                </button>
                            ` : `
                                <div style="color: var(--success); font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> Marked as False Positive
                                </div>
                                <button class="btn" onclick="unignorePlagiarism(${match.match_id})">
                                    <i class="fas fa-undo"></i> Revert
                                </button>
                            `}
                        </div>
                    </div>
                `).join('')}
            </div>
        `).join('')}
    `;
            }

            async function applyPenalty(matchId, answerId, maxMarks) {
                const penaltyInput = document.getElementById(`penalty-${matchId}`);
                const penaltyMarks = parseFloat(penaltyInput.value) || 0;

                if (penaltyMarks <= 0) {
                    alert('Please enter a valid penalty amount');
                    return;
                }

                if (penaltyMarks > maxMarks) {
                    alert(`Penalty cannot exceed ${maxMarks} marks`);
                    return;
                }

                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    const headers = { 'Content-Type': 'application/json' };
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const response = await fetch('/guide/plagiarism/apply-penalty', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            match_id: matchId,
                            answer_id: answerId,
                            penalty_marks: penaltyMarks
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Penalty applied successfully!');
                        // Reload results
                        const assignmentId = document.getElementById('plagiarism_assignment').value;
                        loadPlagiarismResults(assignmentId);
                    } else {
                        alert(data.message || 'Failed to apply penalty');
                    }
                } catch (error) {
                    console.error('Error applying penalty:', error);
                    alert('Error applying penalty');
                }
            }

            async function ignorePlagiarism(matchId) {
                if (!confirm('Mark this as a false positive? No penalty will be applied.')) {
                    return;
                }

                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    const headers = { 'Content-Type': 'application/json' };
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const response = await fetch('/guide/plagiarism/ignore', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ match_id: matchId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Marked as false positive');
                        const assignmentId = document.getElementById('plagiarism_assignment').value;
                        loadPlagiarismResults(assignmentId);
                    }
                } catch (error) {
                    console.error('Error ignoring plagiarism:', error);
                }
            }

            async function undoPenalty(matchId, answerId) {
                if (!confirm('Undo this penalty and restore original marks?')) {
                    return;
                }

                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    const headers = { 'Content-Type': 'application/json' };
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const response = await fetch('/guide/plagiarism/undo-penalty', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            match_id: matchId,
                            answer_id: answerId
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Penalty removed successfully!');
                        const assignmentId = document.getElementById('plagiarism_assignment').value;
                        loadPlagiarismResults(assignmentId);
                    }
                } catch (error) {
                    console.error('Error undoing penalty:', error);
                }
            }

            async function unignorePlagiarism(matchId) {
                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    const headers = { 'Content-Type': 'application/json' };
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const response = await fetch('/guide/plagiarism/unignore', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ match_id: matchId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        const assignmentId = document.getElementById('plagiarism_assignment').value;
                        loadPlagiarismResults(assignmentId);
                    }
                } catch (error) {
                    console.error('Error reverting:', error);
                }
            }

            async function downloadPlagiarismReport(assignmentId) {
                window.open(`/guide/assignments/${assignmentId}/plagiarism-report/pdf`, '_blank');
            }

            // ==================== GUIDE SUMMARIZER FUNCTIONS ====================

            // Load documents on tab show
            document.addEventListener('DOMContentLoaded', function () {
                const summarizerTab = document.querySelector('a[href="#guide-summarizer"]');
                if (summarizerTab) {
                    summarizerTab.addEventListener('click', function () {
                        setTimeout(loadSummarizerDocuments, 100);
                    });
                }
                // Load on initial page load if tab is active
                if (window.location.hash === '#guide-summarizer' || document.querySelector('a[href="#guide-summarizer"]').classList.contains('active')) {
                    loadSummarizerDocuments();
                }
            });

            async function uploadSummarizerDocument() {
                const fileInput = document.getElementById('summarizer-file-input');
                const courseSelect = document.getElementById('summarizer-course-select');
                const file = fileInput.files[0];
                const uploadBtn = document.getElementById('summarizer-upload-btn');

                if (!courseSelect || !courseSelect.value) {
                    showSummarizerAlert('Please select a course first', 'error');
                    return;
                }

                if (!file) {
                    showSummarizerAlert('Please select a file', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('course_id', courseSelect.value);

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    const headers = {};
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const response = await fetch('/guide/summarizer/upload', {
                        method: 'POST',
                        body: formData,
                        headers: headers
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showSummarizerAlert('Document uploaded successfully!', 'success');
                        fileInput.value = '';

                        // Show summary dialog
                        showSummaryDialog(data.filename, data.summary, data.topics);

                        // Reload documents list
                        loadSummarizerDocuments();
                    } else {
                        showSummarizerAlert(data.error || 'Upload failed', 'error');
                    }
                } catch (error) {
                    showSummarizerAlert('Upload error: ' + error.message, 'error');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload & Summarize';
                }
            }

            async function loadSummarizerDocuments() {
                const listContainer = document.getElementById('summarizer-documents-list');
                listContainer.innerHTML = '<p class="text-center text-secondary">Loading documents...</p>';

                try {
                    const response = await fetch('/guide/summarizer/documents');
                    const documents = await response.json();

                    if (documents.length === 0) {
                        listContainer.innerHTML = '<p class="text-center text-secondary">No documents uploaded yet.</p>';
                        return;
                    }

                    let html = '<table class="table glass" style="width: 100%;">';
                    html += '<thead><tr><th>File Name</th><th>Course</th><th>Type</th><th>Pages</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>';

                    documents.forEach(doc => {
                        const uploadDate = new Date(doc.upload_time).toLocaleDateString();
                        const courseName = doc.course_name || '<span style="color: #f56565;">No Course</span>';
                        html += `
                        <tr>
                            <td>${doc.filename}</td>
                            <td>${courseName}</td>
                            <td><span class="badge">${doc.file_type.toUpperCase()}</span></td>
                            <td>${doc.page_count || 0}</td>
                            <td>${uploadDate}</td>
                            <td>
                                <button class="btn btn-sm" onclick="viewSummary(${doc.id}, '${doc.filename}', ${JSON.stringify(doc.summary).replace(/"/g, '&quot;')}, ${JSON.stringify(doc.topics).replace(/"/g, '&quot;')})" title="View Summary">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm" style="background: #ef4444;" onclick="deleteSummarizerDocument(${doc.id})" title="Delete">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                    });

                    html += '</tbody></table>';
                    listContainer.innerHTML = html;
                } catch (error) {
                    listContainer.innerHTML = '<p class="text-center text-error">Error loading documents: ' + error.message + '</p>';
                }
            }

            function viewSummary(docId, filename, summary, topics) {
                const topicsArray = typeof topics === 'string' ? JSON.parse(topics) : topics;
                showSummaryDialog(filename, summary, topicsArray);
            }

            function showSummaryDialog(filename, summary, topics) {
                document.getElementById('summary-dialog-title').textContent = `Summary: ${filename}`;
                document.getElementById('summary-text').textContent = summary || 'No summary available';

                const topicsDiv = document.getElementById('summary-topics');
                if (topics && topics.length > 0) {
                    topicsDiv.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">' +
                        topics.map(topic => `<span class="badge" style="background: var(--accent-color);">${topic}</span>`).join('') +
                        '</div>';
                } else {
                    topicsDiv.innerHTML = '<p class="text-secondary">No topics extracted</p>';
                }

                document.getElementById('summary-dialog').style.display = 'block';
            }

            function closeSummaryDialog() {
                document.getElementById('summary-dialog').style.display = 'none';
            }

            async function deleteSummarizerDocument(docId) {
                if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                    return;
                }

                try {
                    const response = await fetch(`/guide/summarizer/delete/${docId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showSummarizerAlert('Document deleted successfully', 'success');
                        loadSummarizerDocuments();
                    } else {
                        showSummarizerAlert(data.error || 'Delete failed', 'error');
                    }
                } catch (error) {
                    showSummarizerAlert('Delete error: ' + error.message, 'error');
                }
            }

            function showSummarizerAlert(message, type) {
                const container = document.getElementById('summarizer-alert-container');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.style.cssText = 'padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; animation: slideIn 0.3s;';
                alert.style.background = type === 'success' ? '#d1fae5' : '#fee2e2';
                alert.style.color = type === 'success' ? '#065f46' : '#991b1b';
                alert.style.borderLeft = `4px solid ${type === 'success' ? '#10b981' : '#ef4444'}`;
                alert.textContent = message;
                container.appendChild(alert);

                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }

            // Close modal when clicking outside
            window.onclick = function (event) {
                const modal = document.getElementById('summary-dialog');
                if (event.target === modal) {
                    closeSummaryDialog();
                }
            }

            // ==================== VOICE INPUT FOR GUIDE SUMMARIZER ====================
            let isRecordingGuide = false;
            let mediaRecorderGuide = null;
            let audioChunksGuide = [];

            async function toggleVoiceInput() {
                const voiceBtn = document.getElementById('summarizer-voice-btn');
                const statusDiv = document.getElementById('voice-input-status');

                if (!isRecordingGuide) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorderGuide = new MediaRecorder(stream);
                        audioChunksGuide = [];

                        mediaRecorderGuide.ondataavailable = (event) => {
                            audioChunksGuide.push(event.data);
                        };

                        mediaRecorderGuide.onstop = async () => {
                            const audioBlob = new Blob(audioChunksGuide, { type: 'audio/wav' });
                            await transcribeAudioGuide(audioBlob);
                            stream.getTracks().forEach(track => track.stop());
                        };

                        mediaRecorderGuide.start();
                        isRecordingGuide = true;
                        voiceBtn.classList.add('recording');
                        voiceBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
                        statusDiv.style.display = 'block';
                        showSummarizerAlert('Recording started. Click stop when done.', 'success');
                    } catch (error) {
                        showSummarizerAlert('Microphone access denied. Please allow microphone access.', 'error');
                        console.error('Microphone error:', error);
                    }
                } else {
                    if (mediaRecorderGuide && mediaRecorderGuide.state !== 'inactive') {
                        mediaRecorderGuide.stop();
                    }
                    isRecordingGuide = false;
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i> Voice Input';
                    statusDiv.style.display = 'none';
                }
            }

            async function transcribeAudioGuide(audioBlob) {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'audio.wav');

                // Add language selection if specified
                const languageSelect = document.getElementById('voice-language-select');
                if (languageSelect && languageSelect.value) {
                    formData.append('language', languageSelect.value);
                }

                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    const headers = {};
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const response = await fetch('/transcribe', {
                        method: 'POST',
                        body: formData,
                        headers: headers
                    });

                    const data = await response.json();

                    if (response.ok && data.text) {
                        let message = `Transcription: ${data.text}`;
                        if (data.detected_language_name && data.detected_language_name !== 'unknown') {
                            message += `\n\nDetected Language: ${data.detected_language_name} (${data.detected_language})`;
                        }
                        showSummarizerAlert(message, 'success');
                        // You could also populate a text field if you add one
                    } else {
                        showSummarizerAlert('Transcription failed: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showSummarizerAlert('Transcription error: ' + error.message, 'error');
                }
            }

        </script>

        <!-- Guidebot Chatbot -->
        <div id="guidebot-container" class="guidebot-container">
            <div id="guidebot-window" class="guidebot-window">
                <div class="guidebot-header">
                    <div class="guidebot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="guidebot-info">
                        <h3>Guidebot</h3>
                        <span class="guidebot-status">Online</span>
                    </div>
                    <button class="guidebot-close" id="guidebot-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="guidebot-messages" id="guidebot-messages">
                    <div class="guidebot-message bot-message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <p>Hello! I'm <strong>Guidebot</strong>, your AI assistant. How can I help you today? 😊</p>
                            <div class="guidebot-options" id="guidebot-options">
                                <button class="guidebot-option-btn" data-option="upload-materials">
                                    <i class="fas fa-upload"></i>
                                    <span>How to Upload Materials</span>
                                </button>
                                <button class="guidebot-option-btn" data-option="view-assignments">
                                    <i class="fas fa-list"></i>
                                    <span>How to View Assignments</span>
                                </button>
                                <button class="guidebot-option-btn" data-option="ai-grading">
                                    <i class="fas fa-brain"></i>
                                    <span>How AI Grading Works</span>
                                </button>
                                <button class="guidebot-option-btn" data-option="create-assignment">
                                    <i class="fas fa-plus-circle"></i>
                                    <span>How to Create Assignments</span>
                                </button>
                                <button class="guidebot-option-btn" data-option="scores">
                                    <i class="fas fa-chart-line"></i>
                                    <span>How Scores are Shown</span>
                                </button>
                                <button class="guidebot-option-btn" data-option="cheating-detection">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>How Cheating is Detected</span>
                                </button>
                                <button class="guidebot-option-btn" data-option="plagiarism-check">
                                    <i class="fas fa-search"></i>
                                    <span>What Does Plagiarism Check Do</span>
                                </button>
                                <button class="guidebot-option-btn" data-option="rate-feedback">
                                    <i class="fas fa-star"></i>
                                    <span>Rate & Feedback Service</span>
                                </button>
                                <button class="guidebot-option-btn" data-option="suggestions">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>Submit Suggestions</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="guidebot-input-container">
                    <input type="text" id="guidebot-input" class="guidebot-input" placeholder="Ask me anything...">
                    <button id="guidebot-send" class="guidebot-send">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <button id="guidebot-toggle" class="guidebot-toggle">
                <i class="fas fa-comments"></i>
                <span class="guidebot-badge">1</span>
            </button>
        </div>

        <!-- Edit Profile Picture Modal -->
        <div id="editPhotoModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 9999; align-items: center; justify-content: center;">
            <div
                style="background: var(--glass-bg, rgba(255, 255, 255, 0.95)); backdrop-filter: blur(20px); border: 2px solid var(--glass-border, rgba(255, 255, 255, 0.5)); border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-camera"></i> Update Profile Picture</h2>
                    <button onclick="closeEditPhotoModal()"
                        style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-primary, #1a202c);">&times;</button>
                </div>
                <form id="updatePhotoForm" enctype="multipart/form-data">
                    <div style="margin-bottom: 20px;">
                        <label for="profile_photo_input"
                            style="display: block; margin-bottom: 8px; font-weight: 600;">Select New Photo</label>
                        <input type="file" id="profile_photo_input" name="profile_photo" accept="image/*" required
                            style="padding: 12px; border: 2px solid var(--glass-border, rgba(255, 255, 255, 0.5)); border-radius: 8px; background: rgba(255, 255, 255, 0.1); width: 100%; cursor: pointer;">
                        <small style="color: var(--text-secondary, #4a5568); margin-top: 5px; display: block;">Max file
                            size: 5MB. Supported formats: JPG, PNG, GIF</small>
                    </div>
                    <div id="photo-preview" style="margin: 20px 0; text-align: center; display: none;">
                        <img id="photo-preview-img" src="" alt="Preview"
                            style="max-width: 200px; max-height: 200px; border-radius: 50%; border: 3px solid var(--accent-color, #4c51bf);">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeEditPhotoModal()"
                            style="padding: 12px 24px; border: none; border-radius: 8px; background: var(--text-secondary, #4a5568); color: white; cursor: pointer;">Cancel</button>
                        <button type="submit"
                            style="padding: 12px 24px; border: none; border-radius: 8px; background: var(--accent-color, #4c51bf); color: white; cursor: pointer;">
                            <i class="fas fa-upload"></i> Update Photo
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Profile Picture Edit Functions for Guide Dashboard
            function openEditPhotoModal() {
                const modal = document.getElementById('editPhotoModal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeEditPhotoModal() {
                const modal = document.getElementById('editPhotoModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.getElementById('updatePhotoForm').reset();
                    document.getElementById('photo-preview').style.display = 'none';
                }
            }

            // Preview photo before upload
            document.getElementById('profile_photo_input')?.addEventListener('change', function (e) {
                const file = e.target.files[0];
                const preview = document.getElementById('photo-preview');
                const previewImg = document.getElementById('photo-preview-img');

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });

            // Handle profile photo update
            document.getElementById('updatePhotoForm')?.addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    const headers = {};
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }

                    const response = await fetch('/update_profile_picture', {
                        method: 'POST',
                        body: formData,
                        headers: headers
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update profile photo in the UI
                        const profileImg = document.getElementById('profile-photo-img');
                        const profileIcon = document.getElementById('profile-photo-icon');

                        if (profileImg) {
                            profileImg.src = data.photo_url + '?t=' + new Date().getTime();
                        } else if (profileIcon) {
                            profileIcon.style.display = 'none';
                            const avatarDiv = profileIcon.parentElement;
                            const newImg = document.createElement('img');
                            newImg.id = 'profile-photo-img';
                            newImg.src = data.photo_url + '?t=' + new Date().getTime();
                            newImg.alt = 'Profile';
                            newImg.style.width = '100%';
                            newImg.style.height = '100%';
                            newImg.style.objectFit = 'cover';
                            avatarDiv.appendChild(newImg);
                        }

                        closeEditPhotoModal();
                        alert('Profile picture updated successfully!');

                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    } else {
                        alert(data.message || 'Error updating profile picture');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error updating profile picture:', error);
                    alert('An error occurred while updating your profile picture');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });

            // Close modal when clicking outside
            document.getElementById('editPhotoModal')?.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeEditPhotoModal();
                }
            });

            // ========================================
            // Universal Scoreboard Logic
            // ========================================
            let scoreboardInitialized = false;
            let scoreboardCache = null;
            let scoreboardCurrentCourseId = null;

            const scoreboardTabLink = document.querySelector('a[href="#universal-scoreboard"]');
            const scoreboardCourseSelect = document.getElementById('scoreboard_course_select');
            const scoreboardDownloadBtn = document.getElementById('scoreboard-download-btn');
            const scoreboardAssignmentSummary = document.getElementById('scoreboard-assignment-summary');
            const scoreboardMCQSummary = document.getElementById('scoreboard-mcq-summary');
            const scoreboardCourseTitle = document.getElementById('scoreboard-course-title');
            const scoreboardColumnFeedback = document.getElementById('scoreboard-column-feedback');
            const scoreboardTableHead = document.getElementById('scoreboard-table-head');
            const scoreboardTableBody = document.getElementById('scoreboard-table-body');
            const scoreboardTableFoot = document.getElementById('scoreboard-table-foot');
            const scoreboardTableContainer = document.querySelector('.scoreboard-table-container');
            const scoreboardEmptyState = document.getElementById('scoreboard-empty');

            scoreboardTabLink?.addEventListener('click', () => {
                if (!scoreboardInitialized) {
                    scoreboardInitialized = true;
                    initUniversalScoreboard();
                }
            });

            if (window.location.hash === '#universal-scoreboard') {
                scoreboardTabLink?.click();
            }

            function initUniversalScoreboard() {
                if (!scoreboardCourseSelect) {
                    return;
                }

                clearScoreboardTable();
                loadScoreboardCourses();

                scoreboardCourseSelect.addEventListener('change', () => {
                    const courseId = scoreboardCourseSelect.value;
                    scoreboardCurrentCourseId = courseId;
                    setDownloadButtonState(!!courseId);
                    clearScoreboardTable();

                    if (courseId) {
                        loadScoreboardForCourse(courseId);
                    }
                });

                document.getElementById('scoreboard-column-form')?.addEventListener('submit', handleCreateColumn);

                scoreboardDownloadBtn?.addEventListener('click', () => {
                    if (scoreboardCurrentCourseId) {
                        downloadScoreboardPDF(scoreboardCurrentCourseId);
                    }
                });
            }

            async function loadScoreboardCourses() {
                if (!scoreboardCourseSelect) {
                    return;
                }

                scoreboardCourseSelect.innerHTML = '<option value="">Choose course...</option>';

                try {
                    const response = await fetch('/guide/courses');
                    const data = await response.json();

                    if (data.success && Array.isArray(data.courses)) {
                        data.courses.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course.id;
                            option.textContent = course.name;
                            scoreboardCourseSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    setColumnFeedback('Unable to load courses', true);
                }
            }

            async function loadScoreboardForCourse(courseId) {
                if (!courseId) {
                    return;
                }

                try {
                    const response = await fetch(`/guide/scoreboard/course/${courseId}/data`);
                    const data = await response.json();

                    if (!data.success) {
                        setColumnFeedback(data.error || 'Unable to load scoreboard', true);
                        return;
                    }

                    scoreboardCache = data;
                    renderScoreboardTable(data);
                    scoreboardCurrentCourseId = courseId;
                    setDownloadButtonState(true);
                    setColumnFeedback('', false);
                } catch (error) {
                    setColumnFeedback('Unable to load scoreboard data', true);
                }
            }

            function renderScoreboardTable(data) {
                if (!data) {
                    return;
                }

                scoreboardCourseTitle.textContent = `Course: ${escapeHTML(data.course.name || 'Unknown')}`;
                scoreboardAssignmentSummary.textContent = `Assignment Max: ${formatScore(data.assignment_total)}`;
                scoreboardMCQSummary.textContent = `MCQ Max: ${formatScore(data.mcq_total)}`;

                const columns = Array.isArray(data.columns) ? data.columns : [];
                const students = Array.isArray(data.students) ? data.students : [];

                const buildColumnDefinition = (label) => ({
                    text: label,
                    attr: (label || '')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;')
                });

                const assignmentLabel = `Assignments (${formatScore(data.assignment_total)})`;
                const mcqLabel = `MCQ Tests (${formatScore(data.mcq_total)})`;
                const customColumnDefs = columns.map(column => {
                    const name = column.name || 'Custom Column';
                    return buildColumnDefinition(`${name} (${formatScore(column.total_marks)})`);
                });

                const columnDefinitions = [
                    buildColumnDefinition('Student'),
                    buildColumnDefinition(assignmentLabel),
                    buildColumnDefinition(mcqLabel),
                    ...customColumnDefs,
                    buildColumnDefinition('Total')
                ];

                scoreboardTableHead.innerHTML = `<tr>${columnDefinitions.map(def => `<th>${escapeHTML(def.text)}</th>`).join('')}</tr>`;

                if (!students.length) {
                    scoreboardTableBody.innerHTML = '';
                    scoreboardTableFoot.innerHTML = '';
                    toggleScoreboardEmptyState(true);
                    return;
                }

                toggleScoreboardEmptyState(false);

                let assignmentSum = 0;
                let mcqSum = 0;
                let overallTotal = 0;
                const columnTotals = columns.map(() => 0);
                const bodyRows = [];

                students.forEach(student => {
                    const assignmentMarks = Number(student.assignment_marks || 0);
                    const mcqMarks = Number(student.mcq_marks || 0);
                    assignmentSum += assignmentMarks;
                    mcqSum += mcqMarks;

                    let customSum = 0;
                    const customCells = columns.map((column, index) => {
                        const markValue = Number((student.custom_scores[index] || {}).mark || 0);
                        customSum += markValue;
                        columnTotals[index] += markValue;
                        const labelAttr = columnDefinitions[3 + index]?.attr || '';
                        return `
                        <td data-label="${labelAttr}">
                            <div class="score-input-group">
                                <input
                                    type="number"
                                    step="0.5"
                                    min="0"
                                    max="${formatScore(column.total_marks)}"
                                    id="scoreboard-input-${column.id}-${student.learner_id}"
                                    value="${formatScore(markValue)}"
                                >
                        <button class="score-input-button" type="button" onclick="saveScoreboardMark(${column.id}, ${student.learner_id})">Save</button>
                            </div>
                            <span id="scoreboard-status-${column.id}-${student.learner_id}" class="score-input-status"></span>
                        </td>
                    `;
                    });

                    const rowTotal = assignmentMarks + mcqMarks + customSum;
                    overallTotal += rowTotal;

                    const rowCells = [
                        `<td data-label="${columnDefinitions[0].attr}">${escapeHTML(student.learner_name)}</td>`,
                        `<td data-label="${columnDefinitions[1].attr}">${formatScore(assignmentMarks)}</td>`,
                        `<td data-label="${columnDefinitions[2].attr}">${formatScore(mcqMarks)}</td>`,
                        ...customCells,
                        `<td data-label="${columnDefinitions[columnDefinitions.length - 1].attr}" data-row-total="${rowTotal.toFixed(2)}">${formatScore(rowTotal)}</td>`
                    ];

                    bodyRows.push(`<tr>${rowCells.join('')}</tr>`);
                });

                scoreboardTableBody.innerHTML = bodyRows.join('');

                const footerValues = [
                    '<strong>Totals</strong>',
                    formatScore(assignmentSum),
                    formatScore(mcqSum),
                    ...columnTotals.map(total => formatScore(total)),
                    formatScore(overallTotal)
                ];

                const footCells = footerValues.map((value, index) => {
                    const labelAttr = columnDefinitions[index]?.attr || '';
                    return `<td data-label="${labelAttr}">${value}</td>`;
                });

                scoreboardTableFoot.innerHTML = `<tr>${footCells.join('')}</tr>`;
            }

            function clearScoreboardTable() {
                scoreboardTableHead.innerHTML = '';
                scoreboardTableBody.innerHTML = '';
                scoreboardTableFoot.innerHTML = '';
                scoreboardCourseTitle.textContent = 'Select a course to load the universal scoreboard';
                scoreboardAssignmentSummary.textContent = '';
                scoreboardMCQSummary.textContent = '';
                toggleScoreboardEmptyState(true);
                setColumnFeedback('', false);
            }

            function toggleScoreboardEmptyState(showEmpty) {
                if (scoreboardTableContainer) {
                    scoreboardTableContainer.style.display = showEmpty ? 'none' : 'block';
                }
                if (scoreboardEmptyState) {
                    scoreboardEmptyState.style.display = showEmpty ? 'block' : 'none';
                }
            }

            async function handleCreateColumn(event) {
                event.preventDefault();

                if (!scoreboardCurrentCourseId) {
                    setColumnFeedback('Please select a course first.', true);
                    return;
                }

                const nameInput = document.getElementById('scoreboard-column-name');
                const totalInput = document.getElementById('scoreboard-column-total');
                const name = (nameInput?.value || '').trim();
                const totalValue = parseFloat(totalInput?.value);

                if (!name) {
                    setColumnFeedback('Column name is required.', true);
                    return;
                }

                if (Number.isNaN(totalValue)) {
                    setColumnFeedback('Total marks must be a number.', true);
                    return;
                }

                if (totalValue < 0) {
                    setColumnFeedback('Total marks must be positive.', true);
                    return;
                }

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const response = await fetch('/guide/scoreboard/columns', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            course_id: scoreboardCurrentCourseId,
                            name,
                            total_marks: totalValue
                        })
                    });

                    const data = await response.json();
                    if (!data.success) {
                        setColumnFeedback(data.error || 'Unable to create column.', true);
                        return;
                    }

                    nameInput.value = '';
                    totalInput.value = '';
                    setColumnFeedback('Custom column created.', false);
                    loadScoreboardForCourse(scoreboardCurrentCourseId);
                } catch (error) {
                    setColumnFeedback('Error creating column. Try again.', true);
                }
            }

            async function saveScoreboardMark(columnId, learnerId) {
                const input = document.getElementById(`scoreboard-input-${columnId}-${learnerId}`);
                const status = document.getElementById(`scoreboard-status-${columnId}-${learnerId}`);

                if (!input || !status) {
                    return;
                }

                const value = parseFloat(input.value);
                const max = parseFloat(input.getAttribute('max'));

                if (Number.isNaN(value)) {
                    status.textContent = 'Enter a value';
                    status.style.color = '#ef4444';
                    return;
                }

                if (value < 0) {
                    status.textContent = 'Must be ≥ 0';
                    status.style.color = '#ef4444';
                    return;
                }

                if (!Number.isNaN(max) && value > max) {
                    status.textContent = `Max ${formatScore(max)}`;
                    status.style.color = '#ef4444';
                    return;
                }

                status.textContent = 'Saving...';
                status.style.color = '#10b981';

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const response = await fetch(`/guide/scoreboard/columns/${columnId}/value`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            learner_id: learnerId,
                            mark: value
                        })
                    });

                    const data = await response.json();
                    if (!data.success) {
                        status.textContent = data.error || 'Save failed';
                        status.style.color = '#ef4444';
                        return;
                    }

                    if (scoreboardCache) {
                        const student = scoreboardCache.students.find(s => s.learner_id === learnerId);
                        if (student) {
                            const customEntry = student.custom_scores.find(s => s.column_id === columnId);
                            if (customEntry) {
                                customEntry.mark = value;
                            } else {
                                student.custom_scores.push({ column_id: columnId, mark: value });
                            }
                        }
                    }

                    renderScoreboardTable(scoreboardCache || {});

                    const newStatus = document.getElementById(`scoreboard-status-${columnId}-${learnerId}`);
                    if (newStatus) {
                        newStatus.textContent = 'Saved';
                        newStatus.style.color = '#10b981';
                        setTimeout(() => {
                            newStatus.textContent = '';
                        }, 2400);
                    }
                } catch (error) {
                    status.textContent = 'Save failed';
                    status.style.color = '#ef4444';
                }
            }

            function downloadScoreboardPDF(courseId) {
                if (!courseId) {
                    return;
                }

                window.open(`/guide/scoreboard/course/${courseId}/pdf`, '_blank');
            }

            function setDownloadButtonState(enabled) {
                if (!scoreboardDownloadBtn) {
                    return;
                }

                scoreboardDownloadBtn.disabled = !enabled;
            }

            function setColumnFeedback(message, isError) {
                if (!scoreboardColumnFeedback) {
                    return;
                }

                scoreboardColumnFeedback.textContent = message || '';
                scoreboardColumnFeedback.style.color = isError ? '#ef4444' : '#10b981';
            }

            function escapeHTML(value) {
                if (value === null || value === undefined) {
                    return '';
                }
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function formatScore(value) {
                const number = Number(value);
                if (Number.isNaN(number)) {
                    return '0.0';
                }
                return number.toFixed(1);
            }

        </script>

        <div id="mcq-preview-modal"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:2000; align-items:center; justify-content:center; padding:20px;">
            <div
                style="background:#0f172a; color:white; width:100%; max-width:900px; border-radius:16px; padding:25px; max-height:90vh; overflow-y:auto; position:relative;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 class="modal-title" style="margin:0; font-size:1.5rem;">MCQ Preview</h3>
                    <button onclick="closeMCQPreviewModal()"
                        style="background:none; border:none; color:white; font-size:1.4rem; cursor:pointer;">&times;</button>
                </div>
                <div class="modal-body" style="font-size:1rem; line-height:1.6;"></div>
            </div>
        </div>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/guidebot.css') }}">
        <script src="{{ url_for('static', filename='js/guidebot_guide.js') }}"></script>
</body>

</html>