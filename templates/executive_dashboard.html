<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Executive Dashboard - Learning Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/executive_glass.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/guidebot.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
        <div class="floating-particles">
            <span style="--i:1;"></span>
            <span style="--i:2;"></span>
            <span style="--i:3;"></span>
            <span style="--i:4;"></span>
            <span style="--i:5;"></span>
            <span style="--i:6;"></span>
            <span style="--i:7;"></span>
            <span style="--i:8;"></span>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Header -->
        <header class="glass-header">
            <div class="header-content">
                <a href="{{ url_for('executive_dashboard') }}" class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <span class="logo-text">Learning Platform</span>
                </a>
                <div class="header-right">
                    <div class="user-info" style="position: relative;">
                        <div class="user-avatar" style="position: relative; cursor: pointer;" onclick="openEditPhotoModal()" title="Edit Profile Picture">
                            {% if current_user.profile_photo %}
                            <img src="{{ url_for('static', filename=current_user.profile_photo.replace('static/', '')) }}" alt="Profile" id="profile-photo-img">
                            {% else %}
                            <i class="fas fa-user-circle" id="profile-photo-icon"></i>
                            {% endif %}
                            <div class="edit-photo-overlay" style="position: absolute; bottom: 0; right: 0; width: 28px; height: 28px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                <i class="fas fa-camera" style="font-size: 12px; color: white;"></i>
                            </div>
                        </div>
                        <span class="user-name">{{ current_user.full_name }}</span>
                    </div>
                    <a href="{{ url_for('logout') }}" class="btn-logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </header>

        <div class="dashboard-layout">
            <!-- Sidebar -->
            <aside class="glass-sidebar">
                <nav class="sidebar-nav">
                    <a href="#" class="nav-item active" data-section="dashboard">
                        <div class="nav-icon"><i class="fas fa-home"></i></div>
                        <span class="nav-text">Dashboard</span>
                        <div class="nav-indicator"></div>
                    </a>
                    <a href="#" class="nav-item" data-section="all-courses">
                        <div class="nav-icon"><i class="fas fa-book-open"></i></div>
                        <span class="nav-text">All Courses</span>
                        <div class="nav-indicator"></div>
                    </a>
                    <a href="#" class="nav-item" data-section="create-course">
                        <div class="nav-icon"><i class="fas fa-plus-circle"></i></div>
                        <span class="nav-text">Create Course</span>
                        <div class="nav-indicator"></div>
                    </a>
                    <a href="#" class="nav-item" data-section="announcements">
                        <div class="nav-icon"><i class="fas fa-bullhorn"></i></div>
                        <span class="nav-text">Announcements</span>
                        <div class="nav-indicator"></div>
                    </a>
                    <a href="{{ url_for('messages') }}" class="nav-item">
                        <div class="nav-icon"><i class="fas fa-envelope"></i></div>
                        <span class="nav-text">Messages</span>
                        <div class="nav-indicator"></div>
                    </a>
                    <a href="#" class="nav-item" data-section="upgrade">
                        <div class="nav-icon"><i class="fas fa-crown"></i></div>
                        <span class="nav-text">Upgrade</span>
                        <div class="nav-indicator"></div>
                    </a>
                </nav>
                
                <div class="sidebar-footer">
                    <div class="stats-card glass-card">
                        <h4><i class="fas fa-chart-line"></i> Quick Stats</h4>
                        <div class="stat-item">
                            <span class="stat-label">Total Courses</span>
                            <span class="stat-value">{{ courses|length }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Organization</span>
                            <span class="stat-value">{{ current_user.organization_name }}</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="dashboard-main">
                <div id="alert-container"></div>

                <!-- Dashboard Section -->
                <section id="dashboard" class="content-section active">
                    <div class="section-header">
                        <div class="header-text">
                            <h1 class="section-title">Welcome back, {{ current_user.full_name }}!</h1>
                            <p class="section-subtitle">Here's what's happening with your courses today</p>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-box glass-card">
                            <div class="stat-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="stat-content">
                                <h3>{{ courses|length }}</h3>
                                <p>My Courses</p>
                            </div>
                        </div>
                        <div class="stat-box glass-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalLearners">0</h3>
                                <p>Total Learners</p>
                            </div>
                        </div>
                        <div class="stat-box glass-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="stat-content">
                                <h3>{{ courses|length }}</h3>
                                <p>Guides</p>
                            </div>
                        </div>
                        <div class="stat-box glass-card">
                            <div class="stat-icon">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <div class="stat-content">
                                <h3>{{ announcements|length if announcements else 0 }}</h3>
                                <p>Announcements</p>
                            </div>
                        </div>
                    </div>

                    <!-- My Courses -->
                    <div class="courses-container">
                        <div class="container-header">
                            <h2><i class="fas fa-graduation-cap"></i> My Courses</h2>
                        </div>
                        
                        {% if courses %}
                        <div class="courses-grid">
                            {% for course in courses %}
                            <div class="course-card glass-card" data-course-id="{{ course.id }}">
                                <div class="course-header">
                                    <div class="course-icon">
                                        <i class="fas fa-book-reader"></i>
                                    </div>
                                    <h3>{{ course.course_name }}</h3>
                                </div>
                                <div class="course-body">
                                    <div class="course-info">
                                        <p><i class="fas fa-building"></i> {{ course.organization }}</p>
                                        <p><i class="fas fa-calendar"></i> {{ course.created_at.strftime('%B %d, %Y') }}</p>
                                    </div>
                                    
                                    {% if course.guide %}
                                    <div class="guide-section">
                                        <h4><i class="fas fa-user-tie"></i> Guide</h4>
                                        <div class="user-mini-card">
                                            {% if course.guide.profile_photo %}
                                            <img src="{{ url_for('static', filename=course.guide.profile_photo.replace('static/', '')) }}" alt="{{ course.guide.full_name }}">
                                            {% else %}
                                            <div class="avatar-placeholder"><i class="fas fa-user"></i></div>
                                            {% endif %}
                                            <div class="user-mini-info">
                                                <p class="user-name">{{ course.guide.full_name or course.guide.username }}</p>
                                                <p class="user-email">{{ course.guide.email }}</p>
                                            </div>
                                            <span class="status-dot {{ 'online' if course.guide.is_online else 'offline' }}"></span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="learners-section">
                                        <div class="learners-header">
                                            <h4><i class="fas fa-users"></i> Learners ({{ course.learners|length }})</h4>
                                            <button class="btn-icon" onclick="openAddLearnersModal({{ course.id }})">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                        </div>
                                        <div class="learners-grid">
                                            {% for course_learner in course.learners[:4] %}
                                            <div class="learner-avatar" title="{{ course_learner.learner.full_name }}">
                                                {% if course_learner.learner.profile_photo %}
                                                <img src="{{ url_for('static', filename=course_learner.learner.profile_photo.replace('static/', '')) }}" alt="{{ course_learner.learner.full_name }}">
                                                {% else %}
                                                <div class="avatar-placeholder"><i class="fas fa-user"></i></div>
                                                {% endif %}
                                                <span class="status-dot {{ 'online' if course_learner.learner.is_online else 'offline' }}"></span>
                                            </div>
                                            {% endfor %}
                                            {% if course.learners|length > 4 %}
                                            <div class="learner-avatar more">
                                                <span>+{{ course.learners|length - 4 }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="course-actions">
                                    <button class="btn-secondary" onclick="viewCourseDetails({{ course.id }})">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state glass-card">
                            <i class="fas fa-inbox"></i>
                            <h3>No Courses Yet</h3>
                            <p>Create your first course to get started!</p>
                            <button class="btn-primary" onclick="switchSection('create-course')">
                                <i class="fas fa-plus"></i> Create Course
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </section>

                <!-- All Courses Section -->
                <section id="all-courses" class="content-section">
                    <div class="section-header">
                        <h1 class="section-title"><i class="fas fa-book-open"></i> All Courses</h1>
                        <p class="section-subtitle">Browse all courses in the platform</p>
                    </div>
                    
                    <div id="allCoursesContainer" class="courses-grid">
                        <!-- Will be populated dynamically -->
                    </div>
                </section>

                <!-- Create Course Section -->
                <section id="create-course" class="content-section">
                    <div class="section-header">
                        <h1 class="section-title"><i class="fas fa-plus-circle"></i> Create New Course</h1>
                        <p class="section-subtitle">Start building your course curriculum</p>
                    </div>
                    
                    <div class="form-container glass-card">
                        <form id="createCourseForm" class="modern-form">
                            <div class="form-step active" data-step="1">
                                <h3><i class="fas fa-info-circle"></i> Course Information</h3>
                                <div class="form-group">
                                    <label for="course_name">
                                        <i class="fas fa-book"></i> Course Name
                                    </label>
                                    <input type="text" id="course_name" name="course_name" required placeholder="Enter course name">
                                </div>
                                <div class="form-group">
                                    <label for="guide_email">
                                        <i class="fas fa-user-tie"></i> Guide Email
                                    </label>
                                    <input type="email" id="guide_email" name="guide_email" required placeholder="guide@example.com">
                                </div>
                                <button type="button" class="btn-primary btn-next" onclick="nextStep()">
                                    Next <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            
                            <div class="form-step" data-step="2">
                                <h3><i class="fas fa-users"></i> Add Learners</h3>
                                <div class="form-group">
                                    <label for="learner_emails">
                                        <i class="fas fa-envelope"></i> Learner Emails (comma-separated, max 20)
                                    </label>
                                    <textarea id="learner_emails" name="learner_emails" rows="6" placeholder="email1@example.com, email2@example.com, ..."></textarea>
                                    <small class="form-help">Separate multiple emails with commas</small>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary" onclick="prevStep()">
                                        <i class="fas fa-arrow-left"></i> Back
                                    </button>
                                    <button type="submit" class="btn-primary">
                                        <i class="fas fa-check"></i> Create Course
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Announcements Section -->
                <section id="announcements" class="content-section">
                    <div class="section-header">
                        <h1 class="section-title"><i class="fas fa-bullhorn"></i> Announcements</h1>
                        <p class="section-subtitle">Keep everyone informed</p>
                    </div>
                    
                    <div class="announcement-creator glass-card">
                        <h3><i class="fas fa-pen"></i> Create Announcement</h3>
                        <form id="announcementForm" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="ann_title"><i class="fas fa-heading"></i> Title</label>
                                <input type="text" id="ann_title" name="title" required placeholder="Announcement title">
                            </div>
                            <div class="form-group">
                                <label for="ann_content"><i class="fas fa-align-left"></i> Content</label>
                                <textarea id="ann_content" name="content" rows="4" required placeholder="Write your announcement..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="ann_file"><i class="fas fa-paperclip"></i> Attachment (optional)</label>
                                <div class="file-upload">
                                    <input type="file" id="ann_file" name="file" accept=".pdf,.jpg,.jpeg,.png">
                                    <label for="ann_file" class="file-upload-label">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>Choose file or drag here</span>
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-paper-plane"></i> Post Announcement
                            </button>
                        </form>
                    </div>
                    
                    <div class="announcements-list">
                        <h3>Recent Announcements</h3>
                        <div class="announcements-grid">
                            {% for announcement in announcements %}
                            <div class="announcement-card glass-card">
                                <div class="announcement-header">
                                    <h4>{{ announcement.title }}</h4>
                                    <span class="announcement-date">
                                        <i class="far fa-clock"></i>
                                        {{ announcement.created_at.strftime('%b %d, %Y') }}
                                    </span>
                                </div>
                                <div class="announcement-body">
                                    <p>{{ announcement.content }}</p>
                                    {% if announcement.file_path %}
                                    <a href="{{ url_for('download_file', filename=announcement.file_path.split('/')[-1]) }}" class="btn-download">
                                        <i class="fas fa-download"></i> Download Attachment
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </section>

                <!-- Messages Section -->
                <section id="messages" class="content-section">
                    <div class="section-header">
                        <h1 class="section-title"><i class="fas fa-envelope"></i> Messages</h1>
                        <p class="section-subtitle">Communicate with your guides</p>
                    </div>
                    
                    <div class="glass-card messages-container">
                        <div class="messages-placeholder">
                            <i class="fas fa-comments"></i>
                            <h2>Message Your Guides</h2>
                            <p>Start a conversation with guides from your courses</p>
                            <a href="{{ url_for('messages') }}" class="btn-primary" style="margin-top: 20px; display: inline-flex; align-items: center; gap: 8px; text-decoration: none;">
                                <i class="fas fa-paper-plane"></i>
                                Open Messages
                            </a>
                        </div>
                    </div>
                </section>

                <!-- Upgrade Section -->
                <section id="upgrade" class="content-section">
                    <div class="section-header">
                        <h1 class="section-title"><i class="fas fa-crown"></i> Upgrade Your Plan</h1>
                        <p class="section-subtitle">Expand your learning capacity</p>
                    </div>
                    
                    <div class="pricing-grid">
                        <div class="pricing-card glass-card">
                            <div class="plan-badge">Current</div>
                            <div class="plan-icon"><i class="fas fa-star"></i></div>
                            <h3>Basic Plan</h3>
                            <div class="plan-price">
                                <span class="currency">$</span>
                                <span class="amount">0</span>
                                <span class="period">/month</span>
                            </div>
                            <ul class="plan-features">
                                <li><i class="fas fa-check"></i> Up to 20 learners per course</li>
                                <li><i class="fas fa-check"></i> Basic analytics</li>
                                <li><i class="fas fa-check"></i> Email support</li>
                            </ul>
                            <button class="btn-secondary" disabled>Current Plan</button>
                        </div>
                        
                        <div class="pricing-card glass-card featured">
                            <div class="plan-badge popular">Popular</div>
                            <div class="plan-icon"><i class="fas fa-rocket"></i></div>
                            <h3>Pro Plan</h3>
                            <div class="plan-price">
                                <span class="currency">$</span>
                                <span class="amount">29</span>
                                <span class="period">/month</span>
                            </div>
                            <ul class="plan-features">
                                <li><i class="fas fa-check"></i> Up to 50 learners per course</li>
                                <li><i class="fas fa-check"></i> Advanced analytics</li>
                                <li><i class="fas fa-check"></i> Priority support</li>
                                <li><i class="fas fa-check"></i> Custom branding</li>
                            </ul>
                            <button class="btn-primary" onclick="openPaymentModal('pro', 29)">
                                <i class="fas fa-arrow-up"></i> Upgrade Now
                            </button>
                        </div>
                        
                        <div class="pricing-card glass-card">
                            <div class="plan-badge enterprise">Enterprise</div>
                            <div class="plan-icon"><i class="fas fa-building"></i></div>
                            <h3>Enterprise</h3>
                            <div class="plan-price">
                                <span class="currency">$</span>
                                <span class="amount">99</span>
                                <span class="period">/month</span>
                            </div>
                            <ul class="plan-features">
                                <li><i class="fas fa-check"></i> Unlimited learners</li>
                                <li><i class="fas fa-check"></i> Premium analytics</li>
                                <li><i class="fas fa-check"></i> 24/7 phone support</li>
                                <li><i class="fas fa-check"></i> API access</li>
                                <li><i class="fas fa-check"></i> Dedicated account manager</li>
                            </ul>
                            <button class="btn-primary" onclick="openPaymentModal('enterprise', 99)">
                                <i class="fas fa-arrow-up"></i> Upgrade Now
                            </button>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-overlay" onclick="closePaymentModal()"></div>
        <div class="modal-content glass-card payment-modal">
            <button class="modal-close" onclick="closePaymentModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="payment-header">
                <i class="fas fa-credit-card"></i>
                <h2>Complete Your Purchase</h2>
                <p id="selectedPlan"></p>
            </div>
            <form id="paymentForm">
                <input type="hidden" id="plan_type" name="plan_type">
                <input type="hidden" id="plan_amount" name="plan_amount">
                
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Cardholder Name</label>
                    <input type="text" name="card_name" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-credit-card"></i> Card Number</label>
                    <input type="text" name="card_number" required placeholder="1234 5678 9012 3456" maxlength="19">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="far fa-calendar"></i> Expiry</label>
                        <input type="text" name="card_expiry" required placeholder="MM/YY" maxlength="5">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> CVV</label>
                        <input type="text" name="card_cvv" required placeholder="123" maxlength="3">
                    </div>
                </div>
                <div class="payment-summary">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (10%)</span>
                        <span id="tax">$0</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="total">$0</span>
                    </div>
                </div>
                <button type="submit" class="btn-primary btn-block">
                    <i class="fas fa-lock"></i> Pay Now
                </button>
            </form>
        </div>
    </div>

    <!-- Add Learners Modal -->
    <div id="addLearnersModal" class="modal">
        <div class="modal-overlay" onclick="closeAddLearnersModal()"></div>
        <div class="modal-content glass-card">
            <button class="modal-close" onclick="closeAddLearnersModal()">
                <i class="fas fa-times"></i>
            </button>
            <h2><i class="fas fa-user-plus"></i> Add Learners to Course</h2>
            <form id="addLearnersForm">
                <input type="hidden" id="add_course_id" name="course_id">
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Learner Emails (comma-separated, max 20)</label>
                    <textarea id="new_learner_emails" name="learner_emails" rows="5" placeholder="email1@example.com, email2@example.com"></textarea>
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-user-plus"></i> Add Learners
                </button>
            </form>
        </div>
    </div>

    <!-- OTP Modal -->
    <div id="otpModal" class="modal">
        <div class="modal-overlay" onclick="closeOtpModal()"></div>
        <div class="modal-content glass-card">
            <button class="modal-close" onclick="closeOtpModal()">
                <i class="fas fa-times"></i>
            </button>
            <h2><i class="fas fa-shield-alt"></i> Verify Deletion</h2>
            <p>Enter the OTP sent to your email</p>
            <form id="otpForm">
                <input type="hidden" id="delete_user_id" name="user_id">
                <div class="form-group">
                    <label><i class="fas fa-key"></i> OTP Code</label>
                    <input type="text" id="otp_code" name="otp_code" required maxlength="6" placeholder="Enter 6-digit OTP">
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-check"></i> Verify & Delete
                </button>
            </form>
        </div>
    </div>

    <!-- Guidebot Chatbot -->
    <div id="guidebot-container" class="guidebot-container">
        <div id="guidebot-window" class="guidebot-window">
            <div class="guidebot-header">
                <div class="guidebot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="guidebot-info">
                    <h3>Guidebot</h3>
                    <span class="guidebot-status">Online</span>
                </div>
                <button class="guidebot-close" id="guidebot-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="guidebot-messages" id="guidebot-messages">
                <div class="guidebot-message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm <strong>Guidebot</strong>, your AI assistant. How can I help you today? ðŸ˜Š</p>
                        <div class="guidebot-options" id="guidebot-options">
                            <button class="guidebot-option-btn" data-option="create-course">
                                <i class="fas fa-plus-circle"></i>
                                <span>How to Create Course</span>
                            </button>
                            <button class="guidebot-option-btn" data-option="delete-learners">
                                <i class="fas fa-user-minus"></i>
                                <span>How to Delete Learners</span>
                            </button>
                            <button class="guidebot-option-btn" data-option="learner-limit">
                                <i class="fas fa-users"></i>
                                <span>How Many Learners Can Be Added</span>
                            </button>
                            <button class="guidebot-option-btn" data-option="guide-limit">
                                <i class="fas fa-user-tie"></i>
                                <span>How Many Guides Per Course</span>
                            </button>
                            <button class="guidebot-option-btn" data-option="learners-by-date">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Learners Added by Date</span>
                            </button>
                            <button class="guidebot-option-btn" data-option="contact-dev">
                                <i class="fas fa-envelope"></i>
                                <span>Contact Developer</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="guidebot-input-container">
                <input type="text" id="guidebot-input" class="guidebot-input" placeholder="Ask me anything...">
                <button id="guidebot-send" class="guidebot-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        <button id="guidebot-toggle" class="guidebot-toggle">
            <i class="fas fa-comments"></i>
            <span class="guidebot-badge">1</span>
        </button>
    </div>

    <!-- Edit Profile Picture Modal -->
    <div id="editPhotoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: var(--glass-bg, rgba(255, 255, 255, 0.95)); backdrop-filter: blur(20px); border: 2px solid var(--glass-border, rgba(255, 255, 255, 0.5)); border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-camera"></i> Update Profile Picture</h2>
                <button onclick="closeEditPhotoModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-primary, #1a202c);">&times;</button>
            </div>
            <form id="updatePhotoForm" enctype="multipart/form-data">
                <div style="margin-bottom: 20px;">
                    <label for="profile_photo_input" style="display: block; margin-bottom: 8px; font-weight: 600;">Select New Photo</label>
                    <input type="file" id="profile_photo_input" name="profile_photo" accept="image/*" required style="padding: 12px; border: 2px solid var(--glass-border, rgba(255, 255, 255, 0.5)); border-radius: 8px; background: rgba(255, 255, 255, 0.1); width: 100%; cursor: pointer;">
                    <small style="color: var(--text-secondary, #4a5568); margin-top: 5px; display: block;">Max file size: 5MB. Supported formats: JPG, PNG, GIF</small>
                </div>
                <div id="photo-preview" style="margin: 20px 0; text-align: center; display: none;">
                    <img id="photo-preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 50%; border: 3px solid var(--accent-color, #4c51bf);">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeEditPhotoModal()" style="padding: 12px 24px; border: none; border-radius: 8px; background: var(--text-secondary, #4a5568); color: white; cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 12px 24px; border: none; border-radius: 8px; background: var(--accent-color, #4c51bf); color: white; cursor: pointer;">
                        <i class="fas fa-upload"></i> Update Photo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Profile Picture Edit Functions
        function openEditPhotoModal() {
            const modal = document.getElementById('editPhotoModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeEditPhotoModal() {
            const modal = document.getElementById('editPhotoModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                document.getElementById('updatePhotoForm').reset();
                document.getElementById('photo-preview').style.display = 'none';
            }
        }

        // Preview photo before upload
        document.getElementById('profile_photo_input')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('photo-preview');
            const previewImg = document.getElementById('photo-preview-img');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });

        // Handle profile photo update
        document.getElementById('updatePhotoForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            try {
                const response = await fetch('/update_profile_picture', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update profile photo in the UI
                    const profileImg = document.getElementById('profile-photo-img');
                    const profileIcon = document.getElementById('profile-photo-icon');
                    
                    if (profileImg) {
                        profileImg.src = data.photo_url + '?t=' + new Date().getTime();
                    } else if (profileIcon) {
                        profileIcon.style.display = 'none';
                        const avatarDiv = profileIcon.parentElement;
                        const newImg = document.createElement('img');
                        newImg.id = 'profile-photo-img';
                        newImg.src = data.photo_url + '?t=' + new Date().getTime();
                        newImg.alt = 'Profile';
                        avatarDiv.appendChild(newImg);
                    }
                    
                    closeEditPhotoModal();
                    alert('Profile picture updated successfully!');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    alert(data.message || 'Error updating profile picture');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error updating profile picture:', error);
                alert('An error occurred while updating your profile picture');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Close modal when clicking outside
        document.getElementById('editPhotoModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditPhotoModal();
            }
        });
    </script>

    <script src="{{ url_for('static', filename='js/executive_dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/guidebot.js') }}"></script>
</body>
</html>